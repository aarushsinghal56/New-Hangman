<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangman Game</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Canvas Confetti --><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Custom styles for the game */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #6366f1, #22d3ee); /* Indigo 500 to Cyan 400 gradient */
        }
        /* Style for the hangman SVG parts */
        .hangman-part {
            fill: none;
            stroke: #333;
            stroke-width: 4;
            stroke-linecap: round;
            visibility: hidden;
            transition: visibility 0.3s ease-in-out;
        }
        #gallows-base, #gallows-pole, #gallows-beam, #gallows-rope { visibility: visible; }
        .keyboard-button {
            transition: all 0.15s ease-in-out;
            transform: scale(1);
        }
        .keyboard-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .keyboard-button:active:not(:disabled) {
            transform: scale(0.98);
            background-color: #4f46e5;
            box-shadow: none;
        }
        .keyboard-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #e0e0e0 !important;
            color: #888 !important;
            box-shadow: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-gray-800">

    <div class="container mx-auto max-w-lg w-full bg-white rounded-2xl shadow-2xl p-6 md:p-10 transform transition-all duration-300 ease-in-out scale-100">
        
        <!-- === Mode Selection Screen === -->
        <div id="mode-selection-screen" class="space-y-6">
            <h1 class="text-4xl font-extrabold text-center text-indigo-700">Hangman Challenge</h1>
            <p class="text-center text-lg text-gray-700">How do you want to play?</p>
            <button id="play-local-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Play Locally (Hot-Seat)
            </button>
            <button id="play-online-btn" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-green-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Play Online with Friends
            </button>
        </div>

        <!-- === Local Setup Screen === -->
        <div id="local-setup-screen" class="hidden space-y-8">
            <h1 class="text-3xl font-extrabold text-center text-indigo-700">Local Game</h1>
            <p class="text-center text-gray-700 text-lg">Enter a secret word or phrase. Vowels will be revealed automatically!</p>
            <div>
                <label for="local-secret-word-input" class="block text-sm font-medium text-gray-700 mb-2">Secret Word</label>
                <input type="password" id="local-secret-word-input" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="e.g., The Matrix">
            </div>
            <button id="start-local-game-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Start Local Game
            </button>
            <p id="local-setup-error" class="text-red-600 text-center text-sm hidden mt-4"></p>
            <button id="back-to-modes-local-btn" class="w-full text-center text-gray-600 hover:underline mt-4">Back to Menu</button>
        </div>

        <!-- === Online Setup Screen === -->
        <div id="online-setup-screen" class="hidden space-y-8">
            <h1 class="text-3xl font-extrabold text-center text-indigo-700">Online Game</h1>
            
            <!-- Create Game -->
            <div class="border p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center">Create a Game</h2>
                <p class="text-center text-gray-600">This will create a game room for your friend to join.</p>
                <button id="create-game-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                    Create Game Room
                </button>
            </div>

            <!-- Join Game -->
            <div class="border p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center">Join a Game</h2>
                <p class="text-center text-gray-600">Enter the Game ID your friend gave you.</p>
                <div>
                    <label for="join-game-id" class="block text-sm font-medium text-gray-700 mb-2">Game ID</label>
                    <input type="text" id="join-game-id" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="Enter Game ID">
                </div>
                <button id="join-game-btn" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-green-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                    Join Game
                </button>
            </div>
            
            <p id="setup-error" class="text-red-600 text-center text-sm hidden mt-4"></p>
            <p id="user-id-display" class="text-center text-gray-500 text-xs break-all"></p>
            <button id="back-to-modes-online-btn" class="w-full text-center text-gray-600 hover:underline mt-4">Back to Menu</button>
        </div>

        <!-- === Waiting Screen === -->
        <div id="waiting-screen" class="hidden text-center space-y-6">
            <h1 class="text-3xl font-extrabold text-indigo-700">Game Created!</h1>
            <p class="text-lg text-gray-700">Share this Game ID with your friend:</p>
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                <input id="game-id-display" type="text" readonly class="w-full text-center text-2xl font-bold bg-transparent border-none text-gray-800" value="Loading...">
                <button id="copy-game-id-btn" class="mt-4 bg-indigo-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-600 transition">Copy ID</button>
            </div>
            <p class="text-lg text-gray-700">Waiting for a friend to join...</p>
            <div class="loader"></div>
            <button id="cancel-game-btn" class="text-sm text-red-600 hover:underline">Cancel Game</button>
        </div>

        <!-- === Set Word Screen (Online) === -->
        <div id="set-word-screen" class="hidden space-y-8">
            <h1 class="text-3xl font-extrabold text-center text-indigo-700">Your Turn!</h1>
            <p class="text-center text-gray-700 text-lg">Enter a secret word for your friend to guess. Vowels will be revealed.</p>
            <div>
                <label for="online-secret-word-input" class="block text-sm font-medium text-gray-700 mb-2">Secret Word</label>
                <input type="password" id="online-secret-word-input" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="e.g., The Matrix">
            </div>
            <button id="set-online-word-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Set Word
            </button>
            <p id="set-word-error" class="text-red-600 text-center text-sm hidden mt-4"></p>
        </div>

        <!-- === Wait for Word Screen (Online) === -->
        <div id="wait-for-word-screen" class="hidden text-center space-y-6">
            <h1 class="text-3xl font-extrabold text-indigo-700">Get Ready!</h1>
            <p class="text-lg text-gray-700">Your friend is picking a secret word...</p>
            <div class="loader"></div>
        </div>

        <!-- === Game Screen === -->
        <div id="game-screen" class="hidden">
            <div id="score-display" class="mb-4 text-center">
                <h2 class="text-2xl font-bold text-indigo-700">Score</h2>
                <p id="score-text" class="text-lg text-gray-700">You: 0 - Friend: 0</p>
            </div>
            <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-8">Guess the Word!</h1>
            
            <!-- Hangman Drawing -->
            <div class="flex justify-center mb-8 bg-gray-50 p-4 rounded-lg shadow-inner">
                <svg height="250" width="200" viewBox="0 0 200 250">
                    <line id="gallows-base" x1="10" y1="230" x2="130" y2="230" class="hangman-part" style="stroke: #5a67d8;" />
                    <line id="gallows-pole" x1="70" y1="230" x2="70" y2="20" class="hangman-part" style="stroke: #5a67d8;" />
                    <line id="gallows-beam" x1="70" y1="20" x2="170" y2="20" class="hangman-part" style="stroke: #5a67d8;" />
                    <line id="gallows-rope" x1="170" y1="20" x2="170" y2="50" class="hangman-part" style="stroke: #ef4444;" />
                    <circle id="head" cx="170" cy="70" r="20" class="hangman-part" style="stroke: #ef4444; fill: #fee2e2;" />
                    <line id="body" x1="170" y1="90" x2="170" y2="150" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="arm-left" x1="170" y1="110" x2="140" y2="130" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="arm-right" x1="170" y1="110" x2="200" y2="130" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="leg-left" x1="170" y1="150" x2="140" y2="180" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="leg-right" x1="170" y1="150" x2="200" y2="180" class="hangman-part" style="stroke: #ef4444;" />
                </svg>
            </div>

            <!-- Word Display -->
            <div id="word-display" class="flex justify-center flex-wrap gap-x-3 md:gap-x-4 gap-y-2 mb-8 p-3 bg-indigo-50 rounded-lg shadow-inner text-indigo-900">
            </div>

            <!-- Wrong Guesses -->
            <div class="mb-8 text-center bg-red-50 p-3 rounded-lg shadow-inner">
                <h2 class="text-base font-semibold text-red-700 uppercase tracking-wide">Wrong Guesses:</h2>
                <p id="wrong-guesses-display" class="text-2xl font-extrabold text-red-800 h-8 mt-1"></p>
            </div>

            <!-- Keyboard -->
            <div id="keyboard-buttons" class="flex flex-wrap justify-center gap-2 md:gap-3">
            </div>

            <!-- Game Over Message -->
            <div id="game-message" class="text-center mt-10 space-y-5 hidden">
                <h2 id="message-text" class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-500 animate-pulse"></h2>
                <button id="play-again-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-700 transition duration-300 shadow-xl text-xl transform hover:scale-[1.05]">
                    Play Again
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc,
            updateDoc, 
            deleteDoc,
            onSnapshot, 
            collection,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- FIREBASE CONFIGURATION (MANUALLY INSERTED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7s5i4dmBWD0Qtzn6wvOjFuTbbRd9Z1ys",
            authDomain: "new-game-8ba29.firebaseapp.com",
            projectId: "new-game-8ba29",
            storageBucket: "new-game-8ba29.firebasestorage.app",
            messagingSenderId: "788607615409",
            appId: "1:788607615409:web:a812b8d059333523dfbd90"
        };
        const appId = firebaseConfig.projectId;


        // --- DOM Elements ---
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const localSetupScreen = document.getElementById('local-setup-screen');
        const onlineSetupScreen = document.getElementById('online-setup-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const setWordScreen = document.getElementById('set-word-screen');
        const waitForWordScreen = document.getElementById('wait-for-word-screen');
        const gameScreen = document.getElementById('game-screen');
        
        // Mode buttons
        const playLocalBtn = document.getElementById('play-local-btn');
        const playOnlineBtn = document.getElementById('play-online-btn');

        // Local setup
        const localSecretWordInput = document.getElementById('local-secret-word-input');
        const startLocalGameBtn = document.getElementById('start-local-game-btn');
        const localSetupError = document.getElementById('local-setup-error');
        const backToModesLocalBtn = document.getElementById('back-to-modes-local-btn');

        // Online setup
        const createGameBtn = document.getElementById('create-game-btn');
        const joinGameIdInput = document.getElementById('join-game-id');
        const joinGameBtn = document.getElementById('join-game-btn');
        const setupError = document.getElementById('setup-error');
        const userIdDisplay = document.getElementById('user-id-display');
        const backToModesOnlineBtn = document.getElementById('back-to-modes-online-btn');

        // Set Word (Online)
        const onlineSecretWordInput = document.getElementById('online-secret-word-input');
        const setOnlineWordBtn = document.getElementById('set-online-word-btn');
        const setWordError = document.getElementById('set-word-error');

        // Waiting screen
        const gameIdDisplay = document.getElementById('game-id-display');
        const copyGameIdBtn = document.getElementById('copy-game-id-btn');
        const cancelGameBtn = document.getElementById('cancel-game-btn');
        
        // Game screen
        const scoreDisplay = document.getElementById('score-display');
        const scoreText = document.getElementById('score-text');
        const wordDisplay = document.getElementById('word-display');
        const keyboardButtons = document.getElementById('keyboard-buttons');
        const wrongGuessesDisplay = document.getElementById('wrong-guesses-display');
        const gameMessage = document.getElementById('game-message');
        const messageText = document.getElementById('message-text');
        const playAgainBtn = document.getElementById('play-again-btn');

        const hangmanParts = ['head', 'body', 'arm-left', 'arm-right', 'leg-left', 'leg-right'];

        // --- Game State ---
        let gameMode = 'local'; // 'local' or 'online'
        let secretWord = '';
        let guessedLetters = [];
        let wrongGuesses = 0;
        const maxWrongGuesses = 6;
        const vowels = ['A', 'E', 'I', 'O', 'U'];
        const consonants = 'BCDFGHJKLMNPQRSTVWXYZ'.split('');

        // --- Firebase State ---
        let app, auth, db;
        let userId;
        let currentGameId = null;
        let isGameCreator = false; // Tracks if this client created the room
        let currentRoomData = {}; // Caches the latest room data
        let unsubscribeListener = null;
        let isFirebaseInitialized = false;
        
        // --- Firebase Init ---
        async function initializeFirebase() {
            if (isFirebaseInitialized) {
                enableOnlineButtons();
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                isFirebaseInitialized = true;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Your User ID: ${userId}`;
                        enableOnlineButtons();
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (authError) {
                            showError("Authentication failed. Online features are disabled.");
                            disableOnlineButtons();
                        }
                    }
                });
            } catch (e) {
                showError("Error initializing Firebase. Are you online? This mode only works on a live server.");
                disableOnlineButtons();
            }
        }
        
        function showError(message, onSetup = true) {
            const errorP = onSetup ? (gameMode === 'local' ? localSetupError : setupError) : setupError;
            if (gameMode === 'online' && !onSetup) {
                setWordError.textContent = message;
                setWordError.classList.remove('hidden');
                return;
            }
            errorP.textContent = message;
            errorP.classList.remove('hidden');
        }

        function hideAllScreens() {
            modeSelectionScreen.classList.add('hidden');
            localSetupScreen.classList.add('hidden');
            onlineSetupScreen.classList.add('hidden');
            waitingScreen.classList.add('hidden');
            setWordScreen.classList.add('hidden');
            waitForWordScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
        }

        function disableOnlineButtons() {
            createGameBtn.disabled = true;
            joinGameBtn.disabled = true;
            createGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
            joinGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function enableOnlineButtons() {
            createGameBtn.disabled = false;
            joinGameBtn.disabled = false;
            createGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            joinGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- Event Listeners ---
        playLocalBtn.addEventListener('click', () => {
            gameMode = 'local';
            hideAllScreens();
            localSetupScreen.classList.remove('hidden');
        });
        
        playOnlineBtn.addEventListener('click', () => {
            gameMode = 'online';
            hideAllScreens();
            onlineSetupScreen.classList.remove('hidden');
            initializeFirebase();
        });

        startLocalGameBtn.addEventListener('click', startLocalGame);
        backToModesLocalBtn.addEventListener('click', resetGame);
        backToModesOnlineBtn.addEventListener('click', resetGame);

        // Online listeners
        createGameBtn.addEventListener('click', createGame);
        joinGameBtn.addEventListener('click', joinGame);
        setOnlineWordBtn.addEventListener('click', setOnlineWord);
        cancelGameBtn.addEventListener('click', cancelGame);
        copyGameIdBtn.addEventListener('click', copyGameId);
        playAgainBtn.addEventListener('click', handlePlayAgain); // Single handler

        // --- LOCAL GAME FUNCTIONS ---
        function startLocalGame() {
            const word = localSecretWordInput.value.trim().toUpperCase();
            if (!validateWord(word)) return;

            secretWord = word;
            guessedLetters = [...vowels];
            wrongGuesses = 0;
            
            localSecretWordInput.value = '';
            localSetupError.classList.add('hidden');
            
            hideAllScreens();
            gameScreen.classList.remove('hidden');
            scoreDisplay.classList.add('hidden'); // Hide score in local mode

            renderWordDisplay();
            renderKeyboard(true); // Always guesser in local mode
            updateHangmanDrawing();
            wrongGuessesDisplay.textContent = '';
            gameMessage.classList.add('hidden');
        }

        function handleGuessLocal(button) {
            const letter = button.dataset.letter;
            button.disabled = true;
            guessedLetters.push(letter);

            if (secretWord.includes(letter)) {
                renderWordDisplay();
                button.classList.add('bg-green-500', 'text-white');
            } else {
                wrongGuesses++;
                updateWrongGuessesDisplay();
                updateHangmanDrawing();
                button.classList.add('bg-red-500', 'text-white');
            }

            const allLettersGuessed = secretWord.split('').every(
                char => char === ' ' || guessedLetters.includes(char)
            );

            if (allLettersGuessed) {
                endGame(true);
            } else if (wrongGuesses >= maxWrongGuesses) {
                endGame(false);
            }
        }

        // --- ONLINE GAME FUNCTIONS ---

        /**
         * Creates a new game room document in Firestore.
         */
        async function createGame() {
            disableOnlineButtons();
            
            try {
                const gameCollection = collection(db, `artifacts/${appId}/public/data/hangmanGames`);
                const gameDoc = await addDoc(gameCollection, {
                    creatorId: userId,
                    guesserId: null,
                    // Track players and scores
                    players: { [userId]: { name: "Player 1", score: 0 } },
                    // Game state
                    currentWordSetter: userId, // Creator sets first word
                    currentGuesser: null,
                    gameState: 'waiting_for_guesser', // waiting_for_guesser, waiting_for_word, playing, game_over
                    // Round state
                    secretWord: '',
                    guessedLetters: [],
                    wrongGuesses: 0,
                    lastWinnerId: null
                });
                
                currentGameId = gameDoc.id;
                isGameCreator = true;

                gameIdDisplay.value = currentGameId;
                hideAllScreens();
                waitingScreen.classList.remove('hidden');
                
                attachGameListener(currentGameId);
            } catch (e) {
                showError("Failed to create game. Please try again.");
                enableOnlineButtons();
            }
        }

        /**
         * Joins an existing game room.
         */
        async function joinGame() {
            const gameId = joinGameIdInput.value.trim();
            if (gameId.length === 0) {
                showError('Please enter a Game ID to join.');
                return;
            }
            disableOnlineButtons();

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, gameId);
                const gameSnap = await getDoc(gameRef);

                if (!gameSnap.exists()) {
                    showError('Game not found. Check the ID and try again.');
                    enableOnlineButtons();
                    return;
                }
                
                const gameData = gameSnap.data();

                if (gameData.guesserId && gameData.guesserId !== userId) {
                    showError('This game is already full.');
                    enableOnlineButtons();
                    return;
                }

                // Join the game
                let players = gameData.players;
                if (!players[userId]) {
                     players[userId] = { name: "Player 2", score: 0 };
                }

                await updateDoc(gameRef, {
                    guesserId: userId,
                    currentGuesser: userId,
                    players: players,
                    gameState: 'waiting_for_word' // Trigger first round
                });

                currentGameId = gameId;
                isGameCreator = false;
                joinGameIdInput.value = '';

                attachGameListener(currentGameId);

            } catch (e) {
                showError("Failed to join game. Please try again.");
                enableOnlineButtons();
            }
        }

        /**
         * Attaches a real-time listener to the game document.
         * This is the main state machine for the online mode.
         */
        function attachGameListener(gameId) {
            const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, gameId);
            
            if (unsubscribeListener) unsubscribeListener();

            unsubscribeListener = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showError("The game was canceled or deleted.");
                    resetGame();
                    return;
                }

                currentRoomData = docSnap.data();
                const data = currentRoomData;

                // Update shared state
                secretWord = data.secretWord;
                guessedLetters = data.guessedLetters;
                wrongGuesses = data.wrongGuesses;

                const amIWordSetter = userId === data.currentWordSetter;
                const amIGuesser = userId === data.currentGuesser;

                // State machine
                switch (data.gameState) {
                    case 'waiting_for_guesser':
                        hideAllScreens();
                        waitingScreen.classList.remove('hidden');
                        break;
                    
                    case 'waiting_for_word':
                        hideAllScreens();
                        if (amIWordSetter) {
                            setWordScreen.classList.remove('hidden');
                        } else {
                            waitForWordScreen.classList.remove('hidden');
                        }
                        break;
                    
                    case 'playing':
                        hideAllScreens();
                        gameScreen.classList.remove('hidden');
                        scoreDisplay.classList.remove('hidden');
                        gameMessage.classList.add('hidden'); // Hide message on new round
                        
                        renderScoreDisplay();
                        renderWordDisplay();
                        renderKeyboard(amIGuesser); // Only guesser can click
                        updateHangmanDrawing();
                        updateWrongGuessesDisplay();
                        break;
                    
                    case 'game_over':
                        hideAllScreens();
                        gameScreen.classList.remove('hidden');
                        scoreDisplay.classList.remove('hidden');
                        
                        renderScoreDisplay();
                        renderWordDisplay();
                        renderKeyboard(false); // Disable keyboard for all
                        updateHangmanDrawing();
                        updateWrongGuessesDisplay();
                        
                        endGame(data.lastWinnerId === userId); // Show win/lose message
                        break;
                }
            });
        }

        /**
         * Called by the Word Setter to submit their word.
         */
        async function setOnlineWord() {
            const word = onlineSecretWordInput.value.trim().toUpperCase();
            if (!validateWord(word, false)) return;

            setOnlineWordBtn.disabled = true;
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, {
                    secretWord: word,
                    guessedLetters: [...vowels],
                    wrongGuesses: 0,
                    gameState: 'playing'
                });
                onlineSecretWordInput.value = '';
                setWordError.classList.add('hidden');
            } catch (e) {
                showError("Failed to set word. Please try again.", false);
            } finally {
                setOnlineWordBtn.disabled = false;
            }
        }

        /**
         * Handles an online guess, updates Firestore.
         */
        async function handleGuessOnline(button) {
            const letter = button.dataset.letter;
            if (guessedLetters.includes(letter)) return; // Prevent double-clicks

            button.disabled = true; 
            
            let newGuessedLetters = [...guessedLetters, letter];
            let newWrongGuesses = wrongGuesses;
            let newStatus = 'playing';
            let newWinnerId = null;
            let newScores = currentRoomData.players;

            if (!secretWord.includes(letter)) {
                newWrongGuesses++;
            }

            const allLettersGuessed = secretWord.split('').every(
                char => char === ' ' || newGuessedLetters.includes(char)
            );

            if (allLettersGuessed) {
                newStatus = 'game_over';
                newWinnerId = currentRoomData.currentGuesser;
                newScores[newWinnerId].score++;
            } else if (newWrongGuesses >= maxWrongGuesses) {
                newStatus = 'game_over';
                newWinnerId = currentRoomData.currentWordSetter; // Setter wins if guesser fails
                newScores[newWinnerId].score++;
            }
            
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, {
                    guessedLetters: newGuessedLetters,
                    wrongGuesses: newWrongGuesses,
                    gameState: newStatus,
                    lastWinnerId: newWinnerId,
                    players: newScores
                });
            } catch (e) {
                showError("Error submitting guess. Please try again.", false);
                button.disabled = false; // Re-enable if update fails
            }
        }

        /**
         * Triggered by "Next Round" button in online mode.
         */
        async function startNextRound() {
            playAgainBtn.disabled = true; // Prevent spam
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, {
                    // Swap roles
                    currentWordSetter: currentRoomData.currentGuesser,
                    currentGuesser: currentRoomData.currentWordSetter,
                    // Reset round state
                    gameState: 'waiting_for_word',
                    secretWord: '',
                    guessedLetters: [],
                    wrongGuesses: 0,
                    lastWinnerId: null
                });
            } catch (e) {
                showError("Error starting next round. Please try again.", false);
            } finally {
                playAgainBtn.disabled = false;
            }
        }
        
        // --- COMMON GAME FUNCTIONS ---

        function validateWord(word, onSetup = true) {
             if (word.length === 0) {
                showError('Please enter a word or phrase.', onSetup);
                return false;
            }
            const hasConsonant = word.split('').some(letter => consonants.includes(letter));
            if (!hasConsonant) {
                 showError('Please enter a word with at least one consonant.', onSetup);
                return false;
            }
            return true;
        }

        function renderScoreDisplay() {
            if (gameMode !== 'online' || !currentRoomData.players) {
                scoreDisplay.classList.add('hidden');
                return;
            }
            
            const myScore = currentRoomData.players[userId]?.score || 0;
            const opponentId = (userId === currentRoomData.creatorId) ? currentRoomData.guesserId : currentRoomData.creatorId;
            const opponentScore = currentRoomData.players[opponentId]?.score || 0;

            scoreText.textContent = `You: ${myScore}  -  Friend: ${opponentScore}`;
        }
        
        function renderWordDisplay() {
            wordDisplay.innerHTML = '';
            
            secretWord.split('').forEach(char => {
                const letterSpan = document.createElement('span');
                letterSpan.classList.add('font-extrabold', 'text-2xl', 'md:text-4xl', 'uppercase');

                if (char === ' ') {
                    letterSpan.classList.add('w-4', 'md:w-6');
                    letterSpan.innerHTML = '&nbsp;';
                } else if (guessedLetters.includes(char)) {
                    letterSpan.textContent = char;
                    letterSpan.classList.add('text-indigo-900');
                } else {
                    letterSpan.textContent = '_';
                    letterSpan.classList.add('text-indigo-300');
                }
                wordDisplay.appendChild(letterSpan);
            });
        }
        
        function renderKeyboard(canGuess) {
            keyboardButtons.innerHTML = '';
            consonants.forEach(letter => {
                const button = document.createElement('button');
                button.textContent = letter;
                button.classList.add(
                    'keyboard-button', 'w-12', 'h-12', 'md:w-14', 'md:h-14', 
                    'bg-indigo-500', 'text-white', 
                    'font-extrabold', 'text-xl', 'rounded-lg', 'shadow-md'
                );
                button.dataset.letter = letter;

                // Disable if not guesser OR if letter is already guessed
                if (!canGuess || guessedLetters.includes(letter)) {
                    button.disabled = true;
                }

                if (guessedLetters.includes(letter)) {
                    if (secretWord.includes(letter)) {
                         button.classList.add('bg-green-500', 'text-white');
                    } else {
                         button.classList.add('bg-red-500', 'text-white');
                    }
                }

                button.addEventListener('click', () => {
                    if (gameMode === 'local') {
                        handleGuessLocal(button);
                    } else if (gameMode === 'online' && canGuess) {
                        handleGuessOnline(button);
                    }
                });
                keyboardButtons.appendChild(button);
            });
        }
        
        function updateWrongGuessesDisplay() {
            const wrongLetters = guessedLetters.filter(
                letter => !secretWord.includes(letter) && !vowels.includes(letter)
            );
            wrongGuessesDisplay.textContent = wrongLetters.join(', ');
        }

        function updateHangmanDrawing() {
            hangmanParts.forEach(partId => {
                if(document.getElementById(partId)) {
                   document.getElementById(partId).style.visibility = 'hidden';
                }
            });
            for (let i = 0; i < wrongGuesses; i++) {
                if (hangmanParts[i] && document.getElementById(hangmanParts[i])) {
                    document.getElementById(hangmanParts[i]).style.visibility = 'visible';
                }
            }
        }
        
        function endGame(isWin) {
            if (isWin) {
                messageText.textContent = 'YOU WIN!';
                messageText.classList.add('text-green-600', 'bg-gradient-to-r', 'from-cyan-500', 'to-blue-500', 'animate-pulse');
                messageText.style.backgroundImage = 'linear-gradient(to right, var(--tw-gradient-stops))';
                fireConfetti();
            } else {
                messageText.textContent = 'GAME OVER!';
                messageText.classList.add('text-red-600');
                guessedLetters = [...secretWord.split('')];
                renderWordDisplay();
            }
            
            if (gameMode === 'local') {
                playAgainBtn.textContent = 'Play Again';
            } else {
                playAgainBtn.textContent = 'Next Round';
            }
            gameMessage.classList.remove('hidden');
        }

        function handlePlayAgain() {
            if (gameMode === 'local') {
                resetGame();
            } else {
                startNextRound();
            }
        }

        function resetGame() {
            if (gameMode === 'online' && unsubscribeListener) {
                unsubscribeListener();
                unsubscribeListener = null;
            }

            // Reset game state
            secretWord = '';
            guessedLetters = [];
            wrongGuesses = 0;
            currentGameId = null;
            isGameCreator = false;
            currentRoomData = {};
            gameMode = 'local'; // Default back to local

            hideAllScreens();
            modeSelectionScreen.classList.remove('hidden');
            
            gameMessage.classList.add('hidden');
            wrongGuessesDisplay.textContent = '';
            updateHangmanDrawing();
            
            setupError.classList.add('hidden');
            localSetupError.classList.add('hidden');
            setWordError.classList.add('hidden');
            if (isFirebaseInitialized) {
                enableOnlineButtons();
            }
            
            messageText.classList.remove('text-green-600', 'text-red-600', 'bg-gradient-to-r', 'from-cyan-500', 'to-blue-500', 'animate-pulse');
            messageText.style.backgroundImage = '';
        }

        async function cancelGame() {
            if (!currentGameId) {
                resetGame();
                return;
            }
            cancelGameBtn.disabled = true;
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await deleteDoc(gameRef);
            } catch (e) {
                // Ignore error, just reset
            } finally {
                resetGame();
                cancelGameBtn.disabled = false;
            }
        }

        function copyGameId() {
            gameIdDisplay.select();
            try {
                document.execCommand('copy');
                copyGameIdBtn.textContent = 'Copied!';
            } catch (err) {
                copyGameIdBtn.textContent = 'Copy Failed';
            }
            setTimeout(() => {
                copyGameIdBtn.textContent = 'Copy ID';
            }, 2000);
        }

        function fireConfetti() {
            if (typeof confetti !== 'function') return;
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }
    </script>
</body>
</html>
