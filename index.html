<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangman Game</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Canvas Confetti --><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Load Tone.js for Sound --><script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <style>
        /* Custom styles for the game */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to right bottom, #6366f1, #22d3ee); /* Indigo 500 to Cyan 400 gradient */
        }
        /* Style for the hangman SVG parts */
        .hangman-part {
            fill: none;
            stroke: #333;
            stroke-width: 4;
            stroke-linecap: round;
            visibility: hidden;
            transition: visibility 0.3s ease-in-out;
        }
        #gallows-base, #gallows-pole, #gallows-beam, #gallows-rope { visibility: visible; }
        .keyboard-button {
            transition: all 0.15s ease-in-out;
            transform: scale(1);
        }
        .keyboard-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        .keyboard-button:active:not(:disabled) {
            transform: scale(0.98);
            background-color: #4f46e5;
            box-shadow: none;
        }
        .keyboard-button:disabled {
            cursor: not-allowed;
            opacity: 0.6;
            background-color: #e0e0e0 !important;
            color: #888 !important;
            box-shadow: none;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- CHAT POPUP STYLES --- */
        #chat-icon-btn {
            position: absolute;
            bottom: 1.5rem; /* 24px */
            right: 1.5rem; /* 24px */
            z-index: 50;
        }
        #chat-popup {
            position: absolute;
            bottom: 5rem; /* 80px */
            right: 1.5rem; /* 24px */
            width: 300px;
            height: 400px;
            z-index: 40;
            transition: all 0.3s ease-in-out;
            transform-origin: bottom right;
        }
        /* Hide by default */
        #chat-popup.scale-0 {
            transform: scale(0);
            opacity: 0;
        }
        /* Show */
        #chat-popup.scale-100 {
            transform: scale(1);
            opacity: 1;
        }
        #chat-messages {
            scroll-behavior: smooth;
        }
        .emoji-reaction-btn {
            transition: all 0.15s ease-out;
            font-size: 1.5rem; /* 24px */
        }
        .emoji-reaction-btn:hover {
            transform: scale(1.25);
        }

        /* --- EMOJI REACTION STYLES --- */
        #emoji-display-area {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 6rem;
            opacity: 0;
            transition: all 0.5s ease-out;
            z-index: 100;
            pointer-events: none; /* So it doesn't block clicks */
        }
        #emoji-display-area.pop-and-fade {
            animation: popAndFade 2s ease-out forwards;
        }
        @keyframes popAndFade {
            0% { transform: translateX(-50%) scale(0.5); opacity: 0; }
            20% { transform: translateX(-50%) scale(1.2); opacity: 1; }
            40% { transform: translateX(-50%) scale(1); opacity: 1; }
            100% { transform: translateX(-50%) scale(1); opacity: 0; }
        }

        /* Round Selection Buttons */
        .round-btn.selected {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            border-color: #4f46e5;
        }

        /* Hint Button */
        #hint-btn {
            transition: all 0.2s ease;
        }
        #hint-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #d1d5db; /* gray-300 */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 text-gray-800">

    <!-- This is the main container for the game -->
    <div class="container relative mx-auto max-w-lg w-full bg-white rounded-2xl shadow-2xl p-6 md:p-10 transform transition-all duration-300 ease-in-out scale-100">
        
        <!-- === Mode Selection Screen === -->
        <div id="mode-selection-screen" class="space-y-6">
            <h1 class="text-4xl font-extrabold text-center text-indigo-700">Hangman Challenge</h1>
            <p class="text-center text-lg text-gray-700">How do you want to play?</p>
            <button id="play-local-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Play Locally (Hot-Seat)
            </button>
            <button id="play-online-btn" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-green-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Play Online with Friends
            </button>
        </div>

        <!-- === Local Setup Screen === -->
        <div id="local-setup-screen" class="hidden space-y-8">
            <h1 class="text-3xl font-extrabold text-center text-indigo-700">Local Game</h1>
            <p class="text-center text-gray-700 text-lg">Enter a secret word or phrase. Vowels will be revealed automatically!</p>
            <div>
                <label for="local-secret-word-input" class="block text-sm font-medium text-gray-700 mb-2">Secret Word</label>
                <input type="password" id="local-secret-word-input" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="e.g., The Matrix">
            </div>
            <button id="start-local-game-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Start Local Game
            </button>
            <p id="local-setup-error" class="text-red-600 text-center text-sm hidden mt-4"></p>
            <button id="back-to-modes-local-btn" class="w-full text-center text-gray-600 hover:underline mt-4">Back to Menu</button>
        </div>

        <!-- === Online Setup Screen === -->
        <div id="online-setup-screen" class="hidden space-y-8">
            <h1 class="text-3xl font-extrabold text-center text-indigo-700">Online Game</h1>
            <p id="join-invite-message" class="text-center text-lg text-green-700 font-semibold hidden"></p>
            
            <!-- Create Game -->
            <div class="border p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center">Create a Game</h2>
                <div>
                    <label for="create-name-input" class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                    <input type="text" id="create-name-input" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="Enter your name">
                </div>
                <button id="create-game-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                    Create Game Room
                </button>
            </div>

            <!-- Join Game -->
            <div class="border p-4 rounded-lg space-y-4">
                <h2 class="text-2xl font-bold text-gray-800 text-center">Join a Game</h2>
                <div>
                    <label for="join-name-input" class="block text-sm font-medium text-gray-700 mb-2">Your Name</label>
                    <input type="text" id="join-name-input" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="Enter your name">
                </div>
                <div>
                    <label for="join-game-id" class="block text-sm font-medium text-gray-700 mb-2">Game ID</label>
                    <input type="text" id="join-game-id" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="Enter Game ID">
                </div>
                <button id="join-game-btn" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-green-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                    Join Game
                </button>
            </div>
            
            <p id="setup-error" class="text-red-600 text-center text-sm hidden mt-4"></p>
            <p id="user-id-display" class="text-center text-gray-500 text-xs break-all"></p>
            <button id="back-to-modes-online-btn" class="w-full text-center text-gray-600 hover:underline mt-4">Back to Menu</button>
        </div>

        <!-- === Round Selection Screen === -->
        <div id="round-selection-screen" class="hidden space-y-6">
            <h1 class="text-3xl font-extrabold text-center text-indigo-700">Set Match Length</h1>
            <p class="text-center text-gray-700 text-lg">Choose how many rounds you want to play.</p>
            <div class="space-y-3">
                <button data-rounds="3" class="round-btn w-full text-lg border-2 border-gray-300 text-gray-800 font-bold py-4 px-6 rounded-xl hover:bg-gray-100 transition">
                    Quick Match (Best of 3)
                </button>
                <button data-rounds="7" class="round-btn w-full text-lg border-2 border-gray-300 text-gray-800 font-bold py-4 px-6 rounded-xl hover:bg-gray-100 transition">
                    Normal Match (Best of 7)
                </button>
            </div>
            <!-- Custom Match -->
            <div class="space-y-2">
                <button data-rounds="custom" class="round-btn w-full text-lg border-2 border-gray-300 text-gray-800 font-bold py-4 px-6 rounded-xl hover:bg-gray-100 transition">
                    Custom Match
                </button>
                <input type="number" id="custom-rounds-input" min="1" max="99" class="hidden w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="Enter total rounds (e.g., 5)">
            </div>
            <button id="set-rounds-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Start Match
            </button>
            <p id="round-error" class="text-red-600 text-center text-sm hidden mt-4"></p>
        </div>


        <!-- === Waiting Screen === -->
        <div id="waiting-screen" class="hidden text-center space-y-6">
            <h1 class="text-3xl font-extrabold text-indigo-700">Game Created!</h1>
            <p class="text-lg text-gray-700">Share this code with your friend:</p>
            
            <!-- Share Code -->
            <div class="bg-gray-100 p-4 rounded-lg shadow-inner">
                <label for="game-id-display" class="block text-sm font-medium text-gray-700 mb-2">Game Code</label>
                <div class="flex">
                    <input id="game-id-display" type="text" readonly class="w-full text-center text-2xl font-bold bg-white border border-gray-300 rounded-l-lg text-gray-800" value="Loading...">
                    <button id="copy-game-id-btn" class="bg-indigo-500 text-white font-bold py-2 px-4 rounded-r-lg hover:bg-indigo-600 transition">Copy</button>
                </div>
            </div>

            <p class="text-lg text-gray-700">Waiting for a friend to join...</p>
            <div class="loader"></div>
            <button id="cancel-game-btn" class="text-sm text-red-600 hover:underline">Cancel Game</button>
        </div>

        <!-- === Set Word Screen (Online) === -->
        <div id="set-word-screen" class="hidden space-y-8">
            <h1 class="text-3xl font-extrabold text-center text-indigo-700">Your Turn!</h1>
            <p class="text-center text-gray-700 text-lg">Enter a secret word for your friend to guess. Vowels will be revealed.</p>
            <div>
                <label for="online-secret-word-input" class="block text-sm font-medium text-gray-700 mb-2">Secret Word</label>
                <input type="password" id="online-secret-word-input" class="w-full px-5 py-3 border border-gray-300 rounded-xl shadow-inner focus:outline-none focus:ring-3 focus:ring-indigo-400 text-lg" placeholder="e.g., The Matrix">
            </div>
            <button id="set-online-word-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Set Word
            </button>
            <p id="set-word-error" class="text-red-600 text-center text-sm hidden mt-4"></p>
        </div>

        <!-- === Wait for Word Screen (Online) === -->
        <div id="wait-for-word-screen" class="hidden text-center space-y-6">
            <h1 class="text-3xl font-extrabold text-indigo-700">Get Ready!</h1>
            <p class="text-lg text-gray-700">Your friend is picking a secret word...</p>
            <div class="loader"></div>
        </div>

        <!-- === Game Screen === -->
        <div id="game-screen" class="hidden">
            <div class="flex justify-between items-start mb-4">
                <!-- Score & Round Display -->
                <div id="score-display" class="text-left">
                    <h2 class="text-xl font-bold text-indigo-700">Score</h2>
                    <p id="score-text" class="text-lg text-gray-700">You: 0 - Friend: 0</p>
                    <p id="round-text" class="text-sm text-gray-500">Round 1 / 3</p>
                </div>
                <!-- Timer Display -->
                <div id="timer-display" class="text-right">
                    <h2 class="text-xl font-bold text-red-600">Time Left</h2>
                    <p id="timer-text" class="text-lg text-gray-700 font-mono font-bold">02:30</p>
                </div>
            </div>

            <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-4">Guess the Word!</h1>
            
            <!-- Hangman Drawing -->
            <div class="flex justify-center mb-4 bg-gray-50 p-4 rounded-lg shadow-inner">
                <svg height="250" width="200" viewBox="0 0 200 250">
                    <line id="gallows-base" x1="10" y1="230" x2="130" y2="230" class="hangman-part" style="stroke: #5a67d8;" />
                    <line id="gallows-pole" x1="70" y1="230" x2="70" y2="20" class="hangman-part" style="stroke: #5a67d8;" />
                    <line id="gallows-beam" x1="70" y1="20" x2="170" y2="20" class="hangman-part" style="stroke: #5a67d8;" />
                    <line id="gallows-rope" x1="170" y1="20" x2="170" y2="50" class="hangman-part" style="stroke: #ef4444;" />
                    <circle id="head" cx="170" cy="70" r="20" class="hangman-part" style="stroke: #ef4444; fill: #fee2e2;" />
                    <line id="body" x1="170" y1="90" x2="170" y2="150" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="arm-left" x1="170" y1="110" x2="140" y2="130" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="arm-right" x1="170" y1="110" x2="200" y2="130" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="leg-left" x1="170" y1="150" x2="140" y2="180" class="hangman-part" style="stroke: #ef4444;" />
                    <line id="leg-right" x1="170" y1="150" x2="200" y2="180" class="hangman-part" style="stroke: #ef4444;" />
                </svg>
            </div>

            <!-- Word Display -->
            <div id="word-display" class="flex justify-center flex-wrap gap-x-3 md:gap-x-4 gap-y-2 mb-4 p-3 bg-indigo-50 rounded-lg shadow-inner text-indigo-900">
            </div>

            <!-- Wrong Guesses -->
            <div class="mb-4 text-center bg-red-50 p-3 rounded-lg shadow-inner">
                <h2 class="text-base font-semibold text-red-700 uppercase tracking-wide">Wrong Guesses:</h2>
                <p id="wrong-guesses-display" class="text-2xl font-extrabold text-red-800 h-8 mt-1"></p>
            </div>

            <!-- Keyboard or Spectator View -->
            <div id="keyboard-area" class="min-h-[160px]">
                <!-- Hint Button -->
                <div id="hint-area" class="text-center mb-4 hidden">
                    <button id="hint-btn" class="bg-yellow-400 text-yellow-900 font-bold py-2 px-5 rounded-full shadow-lg hover:bg-yellow-500">
                        üí° Get Hint (1 left)
                    </button>
                </div>
                <!-- Keyboard -->
                <div id="keyboard-buttons" class="flex flex-wrap justify-center gap-2 md:gap-3">
                </div>
                <!-- Spectator View -->
                <div id="spectator-view" class="hidden text-center text-gray-700">
                    <p class="text-lg font-semibold">Your friend is guessing...</p>
                    <p class="text-sm">You can chat or send reactions!</p>
                </div>
            </div>


            <!-- Game Over Message -->
            <div id="game-message" class="text-center mt-6 space-y-5 hidden">
                <h2 id="message-text" class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-500 animate-pulse"></h2>
                <button id="play-again-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-full hover:bg-indigo-700 transition duration-300 shadow-xl text-xl transform hover:scale-[1.05]">
                    Play Again
                </button>
            </div>
        </div>

        <!-- === Leaderboard Screen === -->
        <div id="leaderboard-screen" class="hidden text-center space-y-6">
            <h1 class="text-4xl font-extrabold text-indigo-700">Match Over!</h1>
            <div id="winner-announcement" class="text-3xl font-bold text-green-600"></div>
            <div class="bg-gray-100 p-6 rounded-lg shadow-inner space-y-4">
                <h2 class="text-2xl font-bold text-gray-800">Final Score</h2>
                <div id="final-score-you" class="text-xl text-gray-700">You: 0</div>
                <div id="final-score-friend" class="text-xl text-gray-700">Friend: 0</div>
            </div>
            <button id="main-menu-btn" class="w-full bg-indigo-600 text-white font-bold py-4 px-6 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg text-lg transform hover:scale-[1.02]">
                Back to Main Menu
            </button>
        </div>

        <!-- === CHAT ICON === -->
        <button id="chat-toggle-btn" class="hidden absolute bottom-6 right-6 w-16 h-16 bg-indigo-600 text-white rounded-full flex items-center justify-center shadow-lg transition-transform transform hover:scale-110 z-50">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
        </button>

        <!-- === CHAT POPUP === -->
        <div id="chat-popup" class="hidden absolute bottom-24 right-6 w-80 h-96 flex-col bg-white border border-gray-300 rounded-xl shadow-2xl overflow-hidden scale-0 z-40">
            <!-- Chat Header -->
            <div class="flex justify-between items-center p-3 bg-indigo-600 text-white">
                <h3 class="font-bold text-lg">Game Chat</h3>
                <button id="chat-close-btn" class="text-white hover:text-gray-200">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <!-- Chat Messages -->
            <div id="chat-messages" class="flex-1 p-3 space-y-3 overflow-y-auto bg-gray-50">
                <!-- Messages will be injected here -->
            </div>

            <!-- Emoji Reactions -->
            <div class="p-2 bg-gray-100 border-t border-gray-200">
                <div id="emoji-reaction-bar" class="flex justify-around">
                    <button class="emoji-reaction-btn p-1" data-emoji="üëç">üëç</button>
                    <button class="emoji-reaction-btn p-1" data-emoji="üòÇ">üòÇ</button>
                    <button class="emoji-reaction-btn p-1" data-emoji="üòÆ">üòÆ</button>
                    <button class="emoji-reaction-btn p-1" data-emoji="üëè">üëè</button>
                    <button class="emoji-reaction-btn p-1" data-emoji="üò¨">üò¨</button>
                </div>
            </div>

            <!-- Chat Input -->
            <form id="chat-form" class="flex p-3 border-t border-gray-200">
                <input id="chat-input" type="text" class="flex-1 border border-gray-300 rounded-l-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-400" placeholder="Type a message..." autocomplete="off">
                <button type="submit" class="bg-indigo-600 text-white px-4 py-2 rounded-r-lg font-semibold hover:bg-indigo-700">Send</button>
            </form>
        </div>

    </div>

    <!-- === EMOJI DISPLAY AREA === -->
    <div id="emoji-display-area" class=""></div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            addDoc,
            updateDoc, 
            deleteDoc,
            onSnapshot, 
            collection,
            query,
            orderBy,
            serverTimestamp,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";


        // --- FIREBASE CONFIGURATION (MANUALLY INSERTED) ---
        const firebaseConfig = {
            apiKey: "AIzaSyA7s5i4dmBWD0Qtzn6wvOjFuTbbRd9Z1ys",
            authDomain: "new-game-8ba29.firebaseapp.com",
            projectId: "new-game-8ba29",
            storageBucket: "new-game-8ba29.firebasestorage.app",
            messagingSenderId: "788607615409",
            appId: "1:788607615409:web:a812b8d059333523dfbd90"
        };
        const appId = firebaseConfig.projectId;


        // --- DOM Elements ---
        const modeSelectionScreen = document.getElementById('mode-selection-screen');
        const localSetupScreen = document.getElementById('local-setup-screen');
        const onlineSetupScreen = document.getElementById('online-setup-screen');
        const roundSelectionScreen = document.getElementById('round-selection-screen');
        const waitingScreen = document.getElementById('waiting-screen');
        const setWordScreen = document.getElementById('set-word-screen');
        const waitForWordScreen = document.getElementById('wait-for-word-screen');
        const gameScreen = document.getElementById('game-screen');
        const leaderboardScreen = document.getElementById('leaderboard-screen');
        const joinInviteMessage = document.getElementById('join-invite-message');
        
        // Mode buttons
        const playLocalBtn = document.getElementById('play-local-btn');
        const playOnlineBtn = document.getElementById('play-online-btn');

        // Local setup
        const localSecretWordInput = document.getElementById('local-secret-word-input');
        const startLocalGameBtn = document.getElementById('start-local-game-btn');
        const localSetupError = document.getElementById('local-setup-error');
        const backToModesLocalBtn = document.getElementById('back-to-modes-local-btn');

        // Online setup
        const createNameInput = document.getElementById('create-name-input');
        const createGameBtn = document.getElementById('create-game-btn');
        const joinNameInput = document.getElementById('join-name-input');
        const joinGameIdInput = document.getElementById('join-game-id');
        const joinGameBtn = document.getElementById('join-game-btn');
        const setupError = document.getElementById('setup-error');
        const userIdDisplay = document.getElementById('user-id-display');
        const backToModesOnlineBtn = document.getElementById('back-to-modes-online-btn');

        // Round Selection
        const roundButtons = document.querySelectorAll('.round-btn');
        const customRoundsInput = document.getElementById('custom-rounds-input');
        const setRoundsBtn = document.getElementById('set-rounds-btn');
        const roundError = document.getElementById('round-error');

        // Set Word (Online)
        const onlineSecretWordInput = document.getElementById('online-secret-word-input');
        const setOnlineWordBtn = document.getElementById('set-online-word-btn');
        const setWordError = document.getElementById('set-word-error');

        // Waiting screen
        const gameIdDisplay = document.getElementById('game-id-display');
        const copyGameIdBtn = document.getElementById('copy-game-id-btn');
        const cancelGameBtn = document.getElementById('cancel-game-btn');
        
        // Game screen
        const scoreDisplay = document.getElementById('score-display');
        const scoreText = document.getElementById('score-text');
        const roundText = document.getElementById('round-text');
        const timerDisplay = document.getElementById('timer-display');
        const timerText = document.getElementById('timer-text');
        const wordDisplay = document.getElementById('word-display');
        const keyboardArea = document.getElementById('keyboard-area');
        const hintArea = document.getElementById('hint-area');
        const hintBtn = document.getElementById('hint-btn');
        const keyboardButtons = document.getElementById('keyboard-buttons');
        const spectatorView = document.getElementById('spectator-view');
        const wrongGuessesDisplay = document.getElementById('wrong-guesses-display');
        const gameMessage = document.getElementById('game-message');
        const messageText = document.getElementById('message-text');
        const playAgainBtn = document.getElementById('play-again-btn');

        // Leaderboard
        const winnerAnnouncement = document.getElementById('winner-announcement');
        const finalScoreYou = document.getElementById('final-score-you');
        const finalScoreFriend = document.getElementById('final-score-friend');
        const mainMenuBtn = document.getElementById('main-menu-btn');

        // Chat
        const chatToggleBtn = document.getElementById('chat-toggle-btn');
        const chatPopup = document.getElementById('chat-popup');
        const chatCloseBtn = document.getElementById('chat-close-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const emojiReactionBar = document.getElementById('emoji-reaction-bar');

        // Emoji Reaction Display
        const emojiDisplayArea = document.getElementById('emoji-display-area');

        const hangmanParts = ['head', 'body', 'arm-left', 'arm-right', 'leg-left', 'leg-right'];

        // --- Game State ---
        let gameMode = 'local'; // 'local' or 'online'
        let secretWord = '';
        let guessedLetters = [];
        let wrongGuesses = 0;
        const maxWrongGuesses = 6;
        const vowels = ['A', 'E', 'I', 'O', 'U'];
        const consonants = 'BCDFGHJKLMNPQRSTVWXYZ'.split('');
        const emojiList = ['üëç', 'üòÇ', 'üòÆ', 'üëè', 'üò¨'];
        const ROUND_DURATION = 150 * 1000; // 2.5 minutes in ms
        let selectedRounds = 3; // Default

        // --- Firebase State ---
        let app, auth, db;
        let userId;
        let currentGameId = null;
        let isGameCreator = false; // Tracks if this client created the room
        let currentRoomData = {}; // Caches the latest room data
        let gameUnsubscribe = null;
        let chatUnsubscribe = null;
        let isFirebaseInitialized = false;
        let roundTimerInterval = null;

        // --- Sound Effects (Tone.js) ---
        let correctSound, wrongSound, winSound, loseSound;
        let audioInitialized = false;

        function initializeAudio() {
            if (audioInitialized) return;
            correctSound = new Tone.Synth().toDestination();
            wrongSound = new Tone.Synth().toDestination();
            winSound = new Tone.PolySynth(Tone.Synth).toDestination();
            loseSound = new Tone.PolySynth(Tone.Synth).toDestination();
            audioInitialized = true;
        }

        async function playSound(soundType) {
            if (!audioInitialized) return;
            
            // Resume audio context if needed
            if (Tone.context.state !== 'running') {
                await Tone.start();
            }

            const now = Tone.now();
            try {
                if (soundType === 'correct') {
                    correctSound.triggerAttackRelease("C5", "8n", now);
                } else if (soundType === 'wrong') {
                    wrongSound.triggerAttackRelease("E3", "8n", now);
                } else if (soundType === 'win') {
                    winSound.triggerAttackRelease(["C4", "E4", "G4", "C5"], "0.5s", now);
                } else if (soundType === 'lose') {
                    loseSound.triggerAttackRelease(["C3", "G3", "Eb3"], "1s", now);
                }
            } catch (e) {
                console.error("Tone.js error:", e);
            }
        }
        
        // --- Firebase Init ---
        async function initializeFirebase() {
            if (isFirebaseInitialized) {
                enableOnlineButtons();
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                isFirebaseInitialized = true;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = `Your User ID: ${userId}`;
                        enableOnlineButtons();
                    } else {
                        try {
                            await signInAnonymously(auth);
                        } catch (authError) {
                            showError("Authentication failed. Online features are disabled.");
                            disableOnlineButtons();
                        }
                    }
                });
            } catch (e) {
                showError("Error initializing Firebase. Are you online? This mode only works on a live server.");
                disableOnlineButtons();
            }
        }
        
        function showError(message, onSetup = true) {
            let errorP;
            // Determine which error field to show
            if (gameMode === 'local') {
                errorP = localSetupError;
            } else if (currentRoomData.gameState === 'setting_rounds') {
                errorP = roundError;
            } else if (currentRoomData.gameState === 'waiting_for_word') {
                errorP = setWordError;
            } else if (onSetup) {
                errorP = setupError;
            } else {
                // Fallback for non-setup errors, though not ideal
                errorP = setupError; 
            }
            
            errorP.textContent = message;
            errorP.classList.remove('hidden');
        }

        function hideAllErrors() {
            localSetupError.classList.add('hidden');
            setupError.classList.add('hidden');
            roundError.classList.add('hidden');
            setWordError.classList.add('hidden');
            joinInviteMessage.classList.add('hidden');
        }

        function hideAllScreens() {
            modeSelectionScreen.classList.add('hidden');
            localSetupScreen.classList.add('hidden');
            onlineSetupScreen.classList.add('hidden');
            roundSelectionScreen.classList.add('hidden');
            waitingScreen.classList.add('hidden');
            setWordScreen.classList.add('hidden');
            waitForWordScreen.classList.add('hidden');
            gameScreen.classList.add('hidden');
            leaderboardScreen.classList.add('hidden');
            chatToggleBtn.classList.add('hidden');
            chatPopup.classList.add('scale-0');
            chatPopup.classList.add('hidden');
            timerDisplay.classList.add('hidden');
            hideAllErrors();
        }

        function disableOnlineButtons() {
            createGameBtn.disabled = true;
            joinGameBtn.disabled = true;
            createGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
            joinGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
        }

        function enableOnlineButtons() {
            createGameBtn.disabled = false;
            joinGameBtn.disabled = false;
            createGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            joinGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        // --- Event Listeners ---
        playLocalBtn.addEventListener('click', () => {
            gameMode = 'local';
            hideAllScreens();
            localSetupScreen.classList.remove('hidden');
        });
        
        playOnlineBtn.addEventListener('click', () => {
            gameMode = 'online';
            hideAllScreens();
            onlineSetupScreen.classList.remove('hidden');
            initializeFirebase();
        });

        startLocalGameBtn.addEventListener('click', () => {
            initializeAudio(); // Start audio on user interaction
            startLocalGame();
        });
        backToModesLocalBtn.addEventListener('click', resetGame);
        backToModesOnlineBtn.addEventListener('click', resetGame);
        mainMenuBtn.addEventListener('click', resetGame);

        // Online listeners
        createGameBtn.addEventListener('click', () => {
            initializeAudio(); // Start audio on user interaction
            createGame();
        });
        joinGameBtn.addEventListener('click', () => {
            initializeAudio(); // Start audio on user interaction
            joinGame();
        });
        setOnlineWordBtn.addEventListener('click', setOnlineWord);
        cancelGameBtn.addEventListener('click', cancelGame);
        copyGameIdBtn.addEventListener('click', () => copyToClipboard(gameIdDisplay.value, copyGameIdBtn, 'Copy'));
        playAgainBtn.addEventListener('click', handlePlayAgain);
        hintBtn.addEventListener('click', handleHintRequest);

        // Round selection listeners
        roundButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                roundButtons.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedRounds = btn.dataset.rounds;
                if (selectedRounds === 'custom') {
                    customRoundsInput.classList.remove('hidden');
                } else {
                    customRoundsInput.classList.add('hidden');
                }
            });
        });
        setRoundsBtn.addEventListener('click', setRounds);


        // Input sanitization
        function sanitizeSecretWordInput(event) {
            const regex = /[^A-Za-z ]/g;
            event.target.value = event.target.value.replace(regex, '');
        }
        localSecretWordInput.addEventListener('input', sanitizeSecretWordInput);
        onlineSecretWordInput.addEventListener('input', sanitizeSecretWordInput);

        // Chat listeners
        chatToggleBtn.addEventListener('click', toggleChatPopup);
        chatCloseBtn.addEventListener('click', toggleChatPopup);
        chatForm.addEventListener('submit', handleChatSubmit);
        emojiReactionBar.addEventListener('click', handleEmojiClick);

        // --- URL Handling ---
        function checkUrlForGameId() {
            const params = new URLSearchParams(window.location.search);
            const gameId = params.get('game');
            if (gameId) {
                gameMode = 'online';
                hideAllScreens();
                onlineSetupScreen.classList.remove('hidden');
                joinGameIdInput.value = gameId;
                joinInviteMessage.textContent = "Found game invite! Enter your name and click 'Join Game' to begin.";
                joinInviteMessage.classList.remove('hidden');
                initializeFirebase();
            }
        }

        // --- LOCAL GAME FUNCTIONS ---
        function startLocalGame() {
            const word = localSecretWordInput.value.trim().toUpperCase();
            if (!validateWord(word)) return;

            secretWord = word;
            guessedLetters = [...vowels];
            wrongGuesses = 0;
            
            localSecretWordInput.value = '';
            
            hideAllScreens();
            gameScreen.classList.remove('hidden');
            scoreDisplay.classList.add('hidden');
            timerDisplay.classList.add('hidden'); // No timer for local
            hintArea.classList.add('hidden'); // No hint for local

            renderWordDisplay();
            renderKeyboard(true); // Always guesser in local mode
            updateHangmanDrawing();
            wrongGuessesDisplay.textContent = '';
            gameMessage.classList.add('hidden');
        }

        function handleGuessLocal(button) {
            const letter = button.dataset.letter;
            button.disabled = true;
            guessedLetters.push(letter);

            if (secretWord.includes(letter)) {
                playSound('correct');
                renderWordDisplay();
                button.classList.add('bg-green-500', 'text-white');
            } else {
                playSound('wrong');
                wrongGuesses++;
                updateWrongGuessesDisplay();
                updateHangmanDrawing();
                button.classList.add('bg-red-500', 'text-white');
            }

            const allLettersGuessed = secretWord.split('').every(
                char => char === ' ' || guessedLetters.includes(char)
            );

            if (allLettersGuessed) {
                playSound('win');
                endGame(true);
            } else if (wrongGuesses >= maxWrongGuesses) {
                playSound('lose');
                endGame(false);
            }
        }

        // --- ONLINE GAME FUNCTIONS ---

        async function createGame() {
            const playerName = createNameInput.value.trim();
            if (playerName.length < 2) {
                showError("Please enter a name (at least 2 characters).");
                return;
            }
            disableOnlineButtons();
            
            try {
                const gameCollection = collection(db, `artifacts/${appId}/public/data/hangmanGames`);
                const gameDoc = await addDoc(gameCollection, {
                    creatorId: userId,
                    guesserId: null,
                    players: { [userId]: { name: playerName, score: 0 } },
                    currentWordSetter: userId,
                    currentGuesser: null,
                    gameState: 'setting_rounds', // New state
                    totalRounds: 0,
                    currentRound: 0,
                    secretWord: '',
                    guessedLetters: [],
                    wrongGuesses: 0,
                    lastWinnerId: null,
                    lastEmoji: { emoji: '', timestamp: null },
                    roundEndTime: null,
                    hintUsed: false
                });
                
                currentGameId = gameDoc.id;
                isGameCreator = true;
                
                hideAllScreens();
                roundSelectionScreen.classList.remove('hidden');
                
                attachGameListener(currentGameId);
            } catch (e) {
                showError("Failed to create game. Please try again.");
                enableOnlineButtons();
            }
        }

        async function setRounds() {
            let numRounds;
            if (selectedRounds === 'custom') {
                numRounds = parseInt(customRoundsInput.value, 10);
                if (isNaN(numRounds) || numRounds < 1 || numRounds > 99) {
                    showError("Please enter a valid number of rounds (1-99).", false);
                    return;
                }
            } else {
                numRounds = parseInt(selectedRounds, 10);
            }

            setRoundsBtn.disabled = true;
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, {
                    totalRounds: numRounds,
                    gameState: 'waiting_for_guesser'
                });
                
                gameIdDisplay.value = currentGameId;

                hideAllScreens();
                waitingScreen.classList.remove('hidden');

            } catch (e) {
                showError("Failed to set rounds. Please try again.", false);
            } finally {
                setRoundsBtn.disabled = false;
            }
        }

        async function joinGame() {
            const gameId = joinGameIdInput.value.trim();
            const playerName = joinNameInput.value.trim();
            
            if (playerName.length < 2) {
                showError("Please enter a name (at least 2 characters).");
                return;
            }
            if (gameId.length === 0) {
                showError('Please enter a Game ID to join.');
                return;
            }
            disableOnlineButtons();

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, gameId);
                const gameSnap = await getDoc(gameRef);

                if (!gameSnap.exists()) {
                    showError('Game not found. Check the ID and try again.');
                    enableOnlineButtons();
                    return;
                }
                
                const gameData = gameSnap.data();

                if (gameData.guesserId && gameData.guesserId !== userId) {
                    showError('This game is already full.');
                    enableOnlineButtons();
                    return;
                }

                let players = gameData.players;
                if (!players[userId]) {
                     players[userId] = { name: playerName, score: 0 };
                }

                await updateDoc(gameRef, {
                    guesserId: userId,
                    currentGuesser: userId,
                    players: players,
                    gameState: 'waiting_for_word', // Trigger first round
                    currentRound: 1 // Start round 1
                });

                currentGameId = gameId;
                isGameCreator = false;
                joinGameIdInput.value = '';
                joinNameInput.value = '';

                attachGameListener(currentGameId);

            } catch (e) {
                showError("Failed to join game. Please try again.");
                enableOnlineButtons();
            }
        }

        function attachGameListener(gameId) {
            const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, gameId);
            
            if (gameUnsubscribe) gameUnsubscribe();

            gameUnsubscribe = onSnapshot(gameRef, (docSnap) => {
                if (!docSnap.exists()) {
                    showError("The game was canceled or deleted.");
                    resetGame();
                    return;
                }

                const oldData = currentRoomData;
                currentRoomData = docSnap.data();
                const data = currentRoomData;

                // Show emoji reaction
                if (data.lastEmoji && data.lastEmoji.timestamp && 
                    (!oldData.lastEmoji || data.lastEmoji.timestamp !== oldData.lastEmoji.timestamp) &&
                    data.lastEmoji.senderId !== userId) {
                    showEmojiReaction(data.lastEmoji.emoji);
                }

                secretWord = data.secretWord;
                guessedLetters = data.guessedLetters;
                wrongGuesses = data.wrongGuesses;

                const amIWordSetter = userId === data.currentWordSetter;
                const amIGuesser = userId === data.currentGuesser;

                // Show chat icon once game starts
                if (data.gameState !== 'setting_rounds' && data.gameState !== 'waiting_for_guesser') {
                    chatToggleBtn.classList.remove('hidden');
                } else {
                    chatToggleBtn.classList.add('hidden');
                }

                switch (data.gameState) {
                    case 'setting_rounds':
                        if (amIWordSetter) {
                            hideAllScreens();
                            roundSelectionScreen.classList.remove('hidden');
                        } else {
                            // This state shouldn't be seen by guesser
                            showError("Waiting for creator to set up match...");
                        }
                        break;

                    case 'waiting_for_guesser':
                        hideAllScreens();
                        waitingScreen.classList.remove('hidden');
                        break;
                    
                    case 'waiting_for_word':
                        hideAllScreens();
                        chatToggleBtn.classList.remove('hidden');
                        timerDisplay.classList.add('hidden');
                        stopRoundTimer();
                        if (amIWordSetter) {
                            setWordScreen.classList.remove('hidden');
                        } else {
                            waitForWordScreen.classList.remove('hidden');
                        }
                        break;
                    
                    case 'playing':
                        hideAllScreens();
                        gameScreen.classList.remove('hidden');
                        chatToggleBtn.classList.remove('hidden');
                        scoreDisplay.classList.remove('hidden');
                        timerDisplay.classList.remove('hidden');
                        gameMessage.classList.add('hidden');
                        
                        startRoundTimer(data.roundEndTime);
                        renderScoreDisplay();
                        renderWordDisplay();
                        renderKeyboard(amIGuesser);
                        updateHangmanDrawing();
                        updateWrongGuessesDisplay();
                        break;
                    
                    case 'game_over':
                        hideAllScreens();
                        gameScreen.classList.remove('hidden');
                        chatToggleBtn.classList.remove('hidden');
                        scoreDisplay.classList.remove('hidden');
                        timerDisplay.classList.remove('hidden');
                        
                        stopRoundTimer();
                        renderScoreDisplay();
                        renderWordDisplay();
                        renderKeyboard(false);
                        updateHangmanDrawing();
                        updateWrongGuessesDisplay();
                        
                        // Check if match is over or just the round
                        if (data.currentRound >= data.totalRounds) {
                            endGame(data.lastWinnerId === userId, true); // Match is over
                        } else {
                            endGame(data.lastWinnerId === userId, false); // Round is over
                        }
                        break;
                    
                    case 'leaderboard':
                        hideAllScreens();
                        leaderboardScreen.classList.remove('hidden');
                        renderLeaderboard();
                        break;
                }
            });

            // --- Attach Chat Listener ---
            const chatCollection = collection(db, `artifacts/${appId}/public/data/hangmanGames`, gameId, 'messages');
            const q = query(chatCollection, orderBy("timestamp", "desc"));

            if (chatUnsubscribe) chatUnsubscribe();
            
            chatUnsubscribe = onSnapshot(q, (querySnapshot) => {
                chatMessages.innerHTML = '';
                querySnapshot.docs.reverse().forEach(doc => { // Show oldest first
                    renderChatMessage(doc.data());
                });
            });
        }

        async function setOnlineWord() {
            const word = onlineSecretWordInput.value.trim().toUpperCase();
            if (!validateWord(word, false)) return;

            setOnlineWordBtn.disabled = true;
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                const roundEndTime = Date.now() + ROUND_DURATION;
                
                await updateDoc(gameRef, {
                    secretWord: word,
                    guessedLetters: [...vowels],
                    wrongGuesses: 0,
                    gameState: 'playing',
                    roundEndTime: roundEndTime, // Set the timer
                    hintUsed: false // Reset hint for the new round
                });
                onlineSecretWordInput.value = '';
            } catch (e) {
                showError("Failed to set word. Please try again.", false);
            } finally {
                setOnlineWordBtn.disabled = false;
            }
        }

        async function handleGuessOnline(button) {
            const letter = button.dataset.letter;
            if (guessedLetters.includes(letter)) return;

            button.disabled = true; 
            
            let newGuessedLetters = [...guessedLetters, letter];
            let newWrongGuesses = wrongGuesses;
            let newStatus = 'playing';
            let newWinnerId = null;
            let newScores = currentRoomData.players;

            if (secretWord.includes(letter)) {
                playSound('correct');
            } else {
                playSound('wrong');
                newWrongGuesses++;
            }

            const allLettersGuessed = secretWord.split('').every(
                char => char === ' ' || newGuessedLetters.includes(char)
            );

            if (allLettersGuessed) {
                newStatus = 'game_over';
                newWinnerId = currentRoomData.currentGuesser;
                newScores[newWinnerId].score++;
                playSound('win');
            } else if (newWrongGuesses >= maxWrongGuesses) {
                newStatus = 'game_over';
                newWinnerId = currentRoomData.currentWordSetter;
                newScores[newWinnerId].score++;
                playSound('lose');
            }
            
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, {
                    guessedLetters: newGuessedLetters,
                    wrongGuesses: newWrongGuesses,
                    gameState: newStatus,
                    lastWinnerId: newWinnerId,
                    players: newScores
                });
            } catch (e) {
                showError("Error submitting guess. Please try again.", false);
                button.disabled = false;
            }
        }

        async function handleHintRequest() {
            if (currentRoomData.hintUsed || currentRoomData.gameState !== 'playing') {
                return;
            }

            // Find available hint letters (consonants not yet guessed)
            const availableHints = secretWord.split('').filter(char => 
                consonants.includes(char) && !guessedLetters.includes(char)
            );

            if (availableHints.length === 0) {
                // No hints left, just disable the button
                hintBtn.disabled = true;
                hintBtn.textContent = "No Hints Left";
                return;
            }

            hintBtn.disabled = true; // Disable to prevent spam
            
            // Pick a random hint
            const hintLetter = availableHints[Math.floor(Math.random() * availableHints.length)];
            
            let newGuessedLetters = [...guessedLetters, hintLetter];
            let newStatus = 'playing';
            let newWinnerId = null;
            let newScores = currentRoomData.players;

            playSound('correct'); // Play correct sound for hint

            // Check if this hint wins the game
            const allLettersGuessed = secretWord.split('').every(
                char => char === ' ' || newGuessedLetters.includes(char)
            );

            if (allLettersGuessed) {
                newStatus = 'game_over';
                newWinnerId = currentRoomData.currentGuesser;
                newScores[newWinnerId].score++;
                playSound('win');
            }

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, {
                    guessedLetters: newGuessedLetters,
                    gameState: newStatus,
                    lastWinnerId: newWinnerId,
                    players: newScores,
                    hintUsed: true // Mark hint as used
                });
            } catch (e) {
                showError("Error using hint. Please try again.", false);
                hintBtn.disabled = false; // Re-enable if it failed
            }
        }

        async function startNextRound() {
            playAgainBtn.disabled = true;
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, {
                    currentWordSetter: currentRoomData.currentGuesser,
                    currentGuesser: currentRoomData.currentWordSetter,
                    currentRound: currentRoomData.currentRound + 1,
                    gameState: 'waiting_for_word',
                    secretWord: '',
                    guessedLetters: [],
                    wrongGuesses: 0,
                    lastWinnerId: null,
                    roundEndTime: null,
                    hintUsed: false // Reset hint for new round
                });
            } catch (e) {
                showError("Error starting next round. Please try again.", false);
            } finally {
                playAgainBtn.disabled = false;
            }
        }
        
        // --- TIMER FUNCTIONS ---
        
        function startRoundTimer(endTime) {
            stopRoundTimer(); // Clear any existing timer

            roundTimerInterval = setInterval(() => {
                const remainingMs = endTime - Date.now();
                
                if (remainingMs <= 0) {
                    stopRoundTimer();
                    timerText.textContent = "00:00";
                    // Only the guesser can trigger the time-up event
                    if (userId === currentRoomData.currentGuesser && currentRoomData.gameState === 'playing') {
                        handleTimeUp();
                    }
                    return;
                }

                const minutes = Math.floor(remainingMs / 60000);
                const seconds = Math.floor((remainingMs % 60000) / 1000);
                timerText.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopRoundTimer() {
            if (roundTimerInterval) {
                clearInterval(roundTimerInterval);
                roundTimerInterval = null;
            }
        }

        async function handleTimeUp() {
            // Guesser ran out of time, setter wins
            const newScores = currentRoomData.players;
            const winnerId = currentRoomData.currentWordSetter;
            newScores[winnerId].score++;
            
            playSound('lose'); // Play lose sound

            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await updateDoc(gameRef, { 
                    gameState: 'game_over', 
                    lastWinnerId: winnerId, 
                    players: newScores 
                });
            } catch (e) {
                showError("Error finalizing round. Please try again.", false);
            }
        }

        // --- COMMON GAME FUNCTIONS ---

        function validateWord(word, onSetup = true) {
             if (word.length === 0) {
                showError('Please enter a word or phrase.', onSetup);
                return false;
            }
            const hasConsonant = word.split('').every(char => char === ' ' || vowels.includes(char));
            if (hasConsonant) {
                 showError('Please enter a word with at least one consonant.', onSetup);
                return false;
            }
            return true;
        }

        function renderScoreDisplay() {
            if (gameMode !== 'online' || !currentRoomData.players) {
                scoreDisplay.classList.add('hidden');
                return;
            }
            
            const myPlayer = currentRoomData.players[userId];
            const opponentId = (userId === currentRoomData.creatorId) ? currentRoomData.guesserId : currentRoomData.creatorId;
            const opponentPlayer = currentRoomData.players[opponentId];
            
            const myName = myPlayer?.name || "You";
            const myScore = myPlayer?.score || 0;
            const opponentName = opponentPlayer?.name || "Waiting...";
            const opponentScore = opponentPlayer?.score || 0;

            scoreText.textContent = `${myName}: ${myScore}  -  ${opponentName}: ${opponentScore}`;
            roundText.textContent = `Round ${currentRoomData.currentRound} / ${currentRoomData.totalRounds}`;
        }
        
        function renderWordDisplay() {
            wordDisplay.innerHTML = '';
            
            secretWord.split('').forEach(char => {
                const letterSpan = document.createElement('span');
                letterSpan.classList.add('font-extrabold', 'text-2xl', 'md:text-4xl', 'uppercase');

                if (char === ' ') {
                    letterSpan.classList.add('w-4', 'md:w-6');
                    letterSpan.innerHTML = '&nbsp;';
                } else if (guessedLetters.includes(char)) {
                    letterSpan.textContent = char;
                    letterSpan.classList.add('text-indigo-900');
                } else {
                    letterSpan.textContent = '_';
                    letterSpan.classList.add('text-indigo-300');
                }
                wordDisplay.appendChild(letterSpan);
            });
        }
        
        function renderKeyboard(canGuess) {
            keyboardArea.innerHTML = ''; // Clear previous content

            if (canGuess) {
                // Show hint button
                hintArea.classList.remove('hidden');
                keyboardArea.appendChild(hintArea);
                if (currentRoomData.hintUsed) {
                    hintBtn.disabled = true;
                    hintBtn.textContent = "üí° Hint Used";
                } else {
                    hintBtn.disabled = false;
                    hintBtn.textContent = "üí° Get Hint (1 left)";
                }

                // Show keyboard
                keyboardArea.appendChild(keyboardButtons);
                spectatorView.classList.add('hidden');
                keyboardButtons.innerHTML = ''; // Clear old buttons
                consonants.forEach(letter => {
                    const button = document.createElement('button');
                    button.textContent = letter;
                    button.classList.add(
                        'keyboard-button', 'w-12', 'h-12', 'md:w-14', 'md:h-14', 
                        'bg-indigo-500', 'text-white', 
                        'font-extrabold', 'text-xl', 'rounded-lg', 'shadow-md'
                    );
                    button.dataset.letter = letter;

                    if (guessedLetters.includes(letter)) {
                        button.disabled = true;
                        if (secretWord.includes(letter)) {
                            button.classList.add('bg-green-500', 'text-white');
                        } else {
                            button.classList.add('bg-red-500', 'text-white');
                        }
                    }

                    button.addEventListener('click', () => {
                        if (gameMode === 'local') {
                            handleGuessLocal(button);
                        } else if (gameMode === 'online' && canGuess) {
                            handleGuessOnline(button);
                        }
                    });
                    keyboardButtons.appendChild(button);
                });
            } else {
                // Show spectator view
                hintArea.classList.add('hidden');
                keyboardArea.appendChild(spectatorView);
                spectatorView.classList.remove('hidden');
            }
        }
        
        function updateWrongGuessesDisplay() {
            const wrongLetters = guessedLetters.filter(
                letter => !secretWord.includes(letter) && !vowels.includes(letter)
            );
            wrongGuessesDisplay.textContent = wrongLetters.join(', ');
        }

        function updateHangmanDrawing() {
            hangmanParts.forEach(partId => {
                if(document.getElementById(partId)) {
                   document.getElementById(partId).style.visibility = 'hidden';
                }
            });
            for (let i = 0; i < wrongGuesses; i++) {
                if (hangmanParts[i] && document.getElementById(hangmanParts[i])) {
                    document.getElementById(hangmanParts[i]).style.visibility = 'visible';
                }
            }
        }
        
        function endGame(isWin, isMatchOver = false) {
            stopRoundTimer(); // Stop timer as soon as game ends
            
            if (isWin) {
                messageText.textContent = 'YOU WIN!';
                messageText.classList.add('text-green-600', 'bg-gradient-to-r', 'from-cyan-500', 'to-blue-500', 'animate-pulse');
                messageText.style.backgroundImage = 'linear-gradient(to right, var(--tw-gradient-stops))';
                fireConfetti();
                // Play win sound only if it wasn't already played by guess
                if (currentRoomData.gameState !== 'game_over') playSound('win');
            } else {
                messageText.textContent = 'GAME OVER!';
                messageText.classList.add('text-red-600');
                guessedLetters = [...secretWord.split('')];
                renderWordDisplay();
                // Play lose sound only if it wasn't already played by guess
                if (currentRoomData.gameState !== 'game_over') playSound('lose');
            }
            
            if (gameMode === 'local') {
                playAgainBtn.textContent = 'Play Again';
            } else if (isMatchOver) {
                playAgainBtn.textContent = 'View Results';
            } else {
                playAgainBtn.textContent = 'Next Round';
            }
            gameMessage.classList.remove('hidden');
        }

        async function handlePlayAgain() {
            if (gameMode === 'local') {
                resetGame();
            } else {
                // Check if match is over
                if (currentRoomData.currentRound >= currentRoomData.totalRounds) {
                    // Go to leaderboard
                    try {
                        const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                        await updateDoc(gameRef, { gameState: 'leaderboard' });
                    } catch (e) {
                        showError("Error showing leaderboard.", false);
                    }
                } else {
                    // Start next round
                    startNextRound();
                }
            }
        }

        function renderLeaderboard() {
            const myPlayer = currentRoomData.players[userId];
            const opponentId = (userId === currentRoomData.creatorId) ? currentRoomData.guesserId : currentRoomData.creatorId;
            const opponentPlayer = currentRoomData.players[opponentId];
            
            const myName = myPlayer?.name || "You";
            const myScore = myPlayer?.score || 0;
            const opponentName = opponentPlayer?.name || "Friend";
            const opponentScore = opponentPlayer?.score || 0;
            
            finalScoreYou.textContent = `${myName}: ${myScore}`;
            finalScoreFriend.textContent = `${opponentName}: ${opponentScore}`;

            if (myScore > opponentScore) {
                winnerAnnouncement.textContent = `Congratulations, ${myName}!`;
                winnerAnnouncement.classList.remove('text-red-600', 'text-gray-600');
                winnerAnnouncement.classList.add('text-green-600');
                fireConfetti();
            } else if (opponentScore > myScore) {
                winnerAnnouncement.textContent = `${opponentName} Wins!`;
                winnerAnnouncement.classList.remove('text-green-600', 'text-gray-600');
                winnerAnnouncement.classList.add('text-red-600');
            } else {
                winnerAnnouncement.textContent = "It's a Tie!";
                winnerAnnouncement.classList.remove('text-green-600', 'text-red-600');
                winnerAnnouncement.classList.add('text-gray-600');
            }
        }

        function resetGame() {
            if (gameMode === 'online') {
                if (gameUnsubscribe) gameUnsubscribe();
                if (chatUnsubscribe) chatUnsubscribe();
                gameUnsubscribe = null;
                chatUnsubscribe = null;
            }
            stopRoundTimer();

            secretWord = '';
            guessedLetters = [];
            wrongGuesses = 0;
            currentGameId = null;
            isGameCreator = false;
            currentRoomData = {};
            gameMode = 'local';
            selectedRounds = 3;

            hideAllScreens();
            modeSelectionScreen.classList.remove('hidden');
            
            gameMessage.classList.add('hidden');
            wrongGuessesDisplay.textContent = '';
            updateHangmanDrawing();
            
            // Clear name fields
            createNameInput.value = '';
            joinNameInput.value = '';
            
            if (isFirebaseInitialized) {
                enableOnlineButtons();
            }
            
            messageText.classList.remove('text-green-600', 'text-red-600', 'bg-gradient-to-r', 'from-cyan-500', 'to-blue-5g00', 'animate-pulse');
            messageText.style.backgroundImage = '';
        }

        async function cancelGame() {
            if (!currentGameId) {
                resetGame();
                return;
            }
            cancelGameBtn.disabled = true;
            try {
                const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                await deleteDoc(gameRef);
            } catch (e) {
                // Ignore error, just reset
            } finally {
                resetGame();
                cancelGameBtn.disabled = false;
            }
        }

        function copyToClipboard(text, button, defaultText = 'Copy') {
            try {
                // Use execCommand for broader compatibility in iFrames
                const ta = document.createElement('textarea');
                ta.value = text;
                ta.style.position = 'fixed';
                ta.style.left = '-9999px';
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                
                button.textContent = 'Copied!';
            } catch (err) {
                button.textContent = 'Copy Failed';
            }
            setTimeout(() => {
                button.textContent = defaultText;
            }, 2000);
        }

        function fireConfetti() {
            if (typeof confetti !== 'function') return;
            const duration = 3 * 1000;
            const animationEnd = Date.now() + duration;
            const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };
            function randomInRange(min, max) { return Math.random() * (max - min) + min; }
            const interval = setInterval(function() {
                const timeLeft = animationEnd - Date.now();
                if (timeLeft <= 0) return clearInterval(interval);
                const particleCount = 50 * (timeLeft / duration);
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 } }));
                confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 } }));
            }, 250);
        }

        // --- CHAT FUNCTIONS ---
        function toggleChatPopup() {
            chatPopup.classList.toggle('hidden');
            setTimeout(() => {
                chatPopup.classList.toggle('scale-0');
                chatPopup.classList.toggle('scale-100');
            }, 10); // Short delay to allow 'hidden' to apply first
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            const messageText = chatInput.value.trim();
            if (messageText.length === 0) return;

            // Anti-cheat check
            if (secretWord && messageText.toUpperCase().includes(secretWord) && secretWord.length > 2) {
                chatInput.value = '';
                showChatError("You can't send the secret word!");
                return;
            }

            await sendChatMessage(messageText);
            chatInput.value = '';
        }
        
        async function handleEmojiClick(e) {
            if (e.target.classList.contains('emoji-reaction-btn')) {
                const emoji = e.target.dataset.emoji;
                await sendChatMessage(emoji, true);
            }
        }

        async function sendChatMessage(text, isEmoji = false) {
            if (!currentGameId || !userId) return;

            try {
                const chatCollection = collection(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId, 'messages');
                await addDoc(chatCollection, {
                    text: text,
                    senderId: userId,
                    isEmoji: isEmoji,
                    timestamp: serverTimestamp()
                });

                if (isEmoji) {
                    const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId);
                    await updateDoc(gameRef, {
                        lastEmoji: {
                            emoji: text,
                            senderId: userId,
                            timestamp: Date.now() // Use client time for uniqueness
                        }
                    });
                }

            } catch (e) {
                console.error("Error sending message: ", e);
                showChatError("Error sending message.");
            }
        }

        function renderChatMessage(data) {
            if (!data) return;
            const isMe = data.senderId === userId;
            const playerName = currentRoomData.players[data.senderId]?.name || "Player";
            
            const msgDiv = document.createElement('div');
            
            if (data.isEmoji) {
                // Emoji message
                msgDiv.classList.add('text-5xl', isMe ? 'text-right' : 'text-left');
                msgDiv.textContent = data.text;
            } else {
                // Text message
                msgDiv.classList.add('w-full', 'flex', 'flex-col', isMe ? 'items-end' : 'items-start');
                
                const nameSpan = document.createElement('span');
                nameSpan.classList.add('text-xs', 'text-gray-500', 'mb-1', 'px-2');
                nameSpan.textContent = isMe ? "You" : playerName;

                const bubble = document.createElement('div');
                bubble.classList.add('p-3', 'rounded-2xl', 'max-w-[75%]', 'shadow', 'break-words');
                bubble.textContent = data.text;
                
                if (isMe) {
                    bubble.classList.add('bg-indigo-500', 'text-white', 'rounded-br-none');
                } else {
                    bubble.classList.add('bg-gray-200', 'text-gray-800', 'rounded-bl-none');
                }
                msgDiv.appendChild(nameSpan);
                msgDiv.appendChild(bubble);
            }
            
            chatMessages.appendChild(msgDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
        }
        
        function showChatError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('w-full', 'text-center', 'text-red-500', 'text-sm', 'italic');
            errorDiv.textContent = message;
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function showEmojiReaction(emoji) {
            emojiDisplayArea.textContent = emoji;
            emojiDisplayArea.classList.add('pop-and-fade');
            setTimeout(() => {
                emojiDisplayArea.classList.remove('pop-and-fade');
                emojiDisplayArea.textContent = '';
            }, 2000);
        }

        // --- Initial Load ---
        checkUrlForGameId(); // Check for game invite on load

    </script>
</body>
</html>
