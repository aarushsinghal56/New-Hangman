<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hangman Game</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Canvas Confetti --><script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- Load Tone.js for Sound --><script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* === THEME VARIABLES === */
        :root {
            --bg-gradient: linear-gradient(0deg, #FFDEE9 0%, #B5FFFC 100%);
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --text-main: #1e293b;
            --text-muted: #64748b;
            --accent-primary: #4f46e5;
            --accent-secondary: #ec4899;
            --card-bg: white;
            --coin-color: #eab308;
            --letter-color: #4f46e5;
            --slot-border: #cbd5e1;
        }

        [data-theme="candy"] { --bg-gradient: linear-gradient(0deg, #FFDEE9 0%, #B5FFFC 100%); --glass-bg: rgba(255, 255, 255, 0.75); --glass-border: rgba(255, 255, 255, 0.8); --text-main: #1e293b; --text-muted: #64748b; --accent-primary: #4f46e5; --accent-secondary: #ec4899; --card-bg: white; --letter-color: #4f46e5; --slot-border: #cbd5e1; }
        [data-theme="dark"] { --bg-gradient: linear-gradient(180deg, #0f172a 0%, #1e293b 100%); --glass-bg: rgba(30, 41, 59, 0.85); --glass-border: rgba(255, 255, 255, 0.1); --text-main: #f8fafc; --text-muted: #94a3b8; --accent-primary: #818cf8; --accent-secondary: #c084fc; --card-bg: #1e293b; --letter-color: #38bdf8; --slot-border: #475569; }
        [data-theme="neon"] { --bg-gradient: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%); --glass-bg: rgba(15, 23, 42, 0.65); --glass-border: rgba(255, 255, 255, 0.1); --text-main: #f1f5f9; --text-muted: #94a3b8; --accent-primary: #06b6d4; --accent-secondary: #d946ef; --card-bg: #1e293b; --letter-color: #22d3ee; --slot-border: #475569; }
        [data-theme="nature"] { --bg-gradient: linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%); --glass-bg: rgba(255, 255, 255, 0.8); --glass-border: rgba(255, 255, 255, 0.9); --text-main: #064e3b; --text-muted: #065f46; --accent-primary: #059669; --accent-secondary: #d97706; --card-bg: #ecfdf5; --letter-color: #15803d; --slot-border: #86efac; }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            background-size: cover;
            color: var(--text-main);
            min-height: 100vh;
            transition: background 0.8s ease, color 0.5s ease;
            overflow-x: hidden;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 2px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: background 0.5s ease, border-color 0.5s ease;
        }

        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .shake-effect { animation: shake 0.3s ease-in-out; }

        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-100px) scale(1.5); opacity: 0; } }
        .floating-text {
            position: absolute;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
            font-weight: bold;
            color: var(--accent-primary);
            font-size: 1.5rem;
            z-index: 100;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .hangman-part {
            fill: none;
            stroke: var(--accent-secondary);
            stroke-width: 5;
            stroke-linecap: round;
            visibility: hidden;
            transition: visibility 0.3s ease-in-out, stroke 0.5s ease;
        }
        .base-lines { stroke: var(--text-muted); transition: stroke 0.5s ease; }

        .neon-btn {
            background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .neon-btn:hover:not(:disabled) { transform: translateY(-2px); filter: brightness(1.1); }
        .neon-btn:disabled { opacity: 0.6; cursor: not-allowed; background: #94a3b8; }

        .keyboard-button {
            background: var(--card-bg);
            border: 1px solid var(--glass-border);
            color: var(--text-main);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            font-family: 'Space Mono', monospace;
            transition: all 0.2s ease;
        }
        .keyboard-button:hover:not(:disabled) { border-color: var(--accent-primary); color: var(--accent-primary); transform: translateY(-2px); }
        .keyboard-button.correct-guess { background: #dcfce7 !important; border-color: #22c55e !important; color: #15803d !important; }
        .keyboard-button.wrong-guess { background: #fee2e2 !important; border-color: #ef4444 !important; color: #b91c1c !important; }
        [data-theme="neon"] .keyboard-button.correct-guess, [data-theme="dark"] .keyboard-button.correct-guess { background: rgba(34, 197, 94, 0.2) !important; color: #4ade80 !important; border-color: #4ade80 !important; }
        [data-theme="neon"] .keyboard-button.wrong-guess, [data-theme="dark"] .keyboard-button.wrong-guess { background: rgba(239, 68, 68, 0.2) !important; color: #f87171 !important; border-color: #f87171 !important; }
        .keyboard-button.on-fire { border: 2px solid #f59e0b !important; box-shadow: 0 0 10px #f59e0b; animation: pulseFire 1s infinite; }
        @keyframes pulseFire { 0% { box-shadow: 0 0 5px #f59e0b; } 50% { box-shadow: 0 0 15px #f97316; } 100% { box-shadow: 0 0 5px #f59e0b; } }

        input { background: var(--card-bg); border: 2px solid var(--glass-border); color: var(--text-main); transition: background 0.5s ease, color 0.5s ease; }
        .modal-content, .lobby-card { background: var(--card-bg); color: var(--text-main); transition: background 0.5s ease, color 0.5s ease; }

        .game-container { max-width: 600px; width: 100%; padding: 1.5rem; border-radius: 1.5rem; }
        
        .powerup-btn { transition: transform 0.2s, filter 0.2s; }
        .powerup-btn:hover:not(:disabled) { transform: scale(1.05); }
        .powerup-btn:disabled { filter: grayscale(100%); opacity: 0.5; cursor: not-allowed; }
        .powerup-cost { font-size: 0.6rem; font-weight: 800; color: var(--coin-color); background: rgba(0,0,0,0.05); padding: 1px 4px; border-radius: 4px; margin-top: 2px; }
        
        .lobby-tab.active { border-bottom: 3px solid var(--accent-primary); color: var(--accent-primary); background: rgba(0,0,0,0.05); }
        
        .avatar-circle {
            width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 32px; border: 2px solid white; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.2s; cursor: pointer;
        }
        .avatar-circle:hover { transform: scale(1.1); }
        
        .word-slot-revealed { color: var(--letter-color) !important; border-bottom-color: var(--letter-color) !important; }
        .word-slot-empty { border-bottom-color: var(--slot-border); color: transparent; }

        /* === CHAT STYLES === */
        #chat-desktop {
            position: fixed; top: 50%; right: 20px; transform: translateY(-50%);
            width: 300px; height: 500px; z-index: 40;
            display: none;
            flex-direction: column;
        }
        #chat-desktop.active { display: flex; }

        #chat-mobile {
            position: fixed; bottom: 80px; right: 20px;
            width: 280px; height: 350px; z-index: 50;
            transform-origin: bottom right; transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .chat-msg { padding: 8px 12px; margin-bottom: 8px; border-radius: 12px; font-size: 0.9rem; max-width: 85%; }
        .chat-msg.me { background: var(--accent-primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
        .chat-msg.them { background: rgba(0,0,0,0.05); color: var(--text-main); align-self: flex-start; border-bottom-left-radius: 2px; border: 1px solid var(--glass-border); }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4" data-theme="candy">

    <!-- === THEME TOGGLE === -->
    <div id="theme-toggles" class="fixed top-4 left-4 z-50 flex gap-2">
        <button class="theme-btn w-10 h-10 rounded-full bg-white shadow flex items-center justify-center text-xl hover:scale-110 transition" data-set-theme="candy" title="Candy Theme">üç¨</button>
        <button class="theme-btn w-10 h-10 rounded-full bg-gray-800 text-white shadow flex items-center justify-center text-xl hover:scale-110 transition" data-set-theme="dark" title="Dark Theme">üåë</button>
        <button class="theme-btn w-10 h-10 rounded-full bg-slate-900 text-cyan-400 shadow flex items-center justify-center text-xl hover:scale-110 transition" data-set-theme="neon" title="Neon Theme">üåÉ</button>
        <button class="theme-btn w-10 h-10 rounded-full bg-emerald-100 shadow flex items-center justify-center text-xl hover:scale-110 transition" data-set-theme="nature" title="Nature Theme">üåø</button>
    </div>

    <!-- === SETTINGS MODAL === -->
    <div id="settings-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="modal-content rounded-2xl p-8 w-full max-w-sm relative shadow-2xl">
            <h2 class="text-3xl font-bold text-center mb-6" style="color: var(--accent-primary)">Settings</h2>
            <div class="space-y-3">
                <button id="settings-resume-btn" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-xl shadow hover:brightness-110">Resume</button>
                <button id="settings-change-difficulty-btn" class="w-full bg-amber-500 text-white font-bold py-3 rounded-xl shadow hover:brightness-110 hidden">Change Difficulty</button>
                <button id="settings-quit-btn" class="w-full bg-rose-500 text-white font-bold py-3 rounded-xl shadow hover:brightness-110">Quit Game</button>
            </div>
        </div>
    </div>

    <!-- === HOW TO PLAY MODAL === -->
    <div id="how-to-play-modal" class="modal-overlay hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
        <div class="modal-content rounded-2xl p-8 w-full max-w-lg relative shadow-2xl flex flex-col max-h-[90vh]">
            <button id="how-to-play-close-btn" class="absolute top-4 right-4 text-2xl hover:scale-110 transition">&times;</button>
            <h2 class="text-3xl font-bold text-center mb-4" style="color: var(--accent-primary)">How to Play</h2>
            <div class="flex-1 overflow-hidden relative min-h-[200px] flex items-center">
                <div id="flashcard-container" class="flex transition-transform duration-300 w-full">
                    <div class="w-full flex-shrink-0 text-center p-4 space-y-3">
                        <div class="text-6xl mb-2">ü§î</div>
                        <h3 class="text-xl font-bold">The Goal</h3>
                        <p class="opacity-80">Guess the secret word letter by letter before the hangman is fully drawn (6 mistakes).</p>
                    </div>
                    <div class="w-full flex-shrink-0 text-center p-4 space-y-3">
                        <div class="text-6xl mb-2">üëÄ</div>
                        <h3 class="text-xl font-bold">Spectator Mode</h3>
                        <p class="opacity-80">Join a full room to watch! You can't guess, but you can spam taunts and emojis to distract the player.</p>
                    </div>
                    <div class="w-full flex-shrink-0 text-center p-4 space-y-3">
                        <div class="text-6xl mb-2">üöÄ</div>
                        <h3 class="text-xl font-bold">Power-Ups</h3>
                        <p class="opacity-80">üí£ Bomb (6c): Removes letters.<br>üõ°Ô∏è Shield (4c): Blocks mistake.<br>‚ùÑÔ∏è Freeze (2c): Stops timer.</p>
                    </div>
                    <div class="w-full flex-shrink-0 text-center p-4 space-y-3">
                        <div class="text-6xl mb-2">üòé</div>
                        <h3 class="text-xl font-bold">Customization</h3>
                        <p class="opacity-80">Customize your avatar's color AND face! Win games to earn coins for abilities.</p>
                    </div>
                </div>
            </div>
            <div class="flex justify-between items-center mt-6">
                <button id="fc-prev" class="px-4 py-2 rounded-lg border hover:bg-black/5 disabled:opacity-30">Prev</button>
                <div id="fc-dots" class="flex gap-2"></div>
                <button id="fc-next" class="px-4 py-2 rounded-lg border hover:bg-black/5 disabled:opacity-30">Next</button>
            </div>
        </div>
    </div>

    <!-- === MAIN GAME UI === -->
    <main class="main-layout flex justify-center w-full">

        <!-- === GAME CONTAINER === -->
        <div class="game-container glass-panel relative flex flex-col items-center" id="game-container">
            
            <!-- Top Controls -->
            <button id="settings-btn" class="absolute top-4 left-4 w-10 h-10 rounded-full bg-white/50 hover:bg-white shadow flex items-center justify-center font-bold transition hidden z-20">‚öôÔ∏è</button>
            <button id="how-to-play-btn" class="absolute top-4 right-4 w-10 h-10 rounded-full bg-white/50 hover:bg-white shadow flex items-center justify-center font-bold transition z-20">?</button>

            <!-- === MAIN MENU === -->
            <div id="mode-selection-screen" class="w-full text-center space-y-6 py-8">
                <h1 class="text-6xl font-extrabold tracking-tighter mb-2" style="color: var(--accent-primary)">HANGMAN</h1>
                <div class="grid gap-4 max-w-md mx-auto">
                    <button id="play-daily-btn" class="neon-btn py-4 rounded-2xl text-xl font-bold shadow-lg relative overflow-hidden group">
                        <span class="relative z-10">üìÖ Daily Challenge</span>
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform"></div>
                    </button>
                    <button id="play-local-btn" class="neon-btn py-4 rounded-2xl text-xl font-bold shadow-lg" style="--accent-primary: #0ea5e9; --accent-secondary: #3b82f6;">
                        üéÆ Play Locally
                    </button>
                    <button id="play-online-btn" class="neon-btn py-4 rounded-2xl text-xl font-bold shadow-lg" style="--accent-primary: #10b981; --accent-secondary: #059669;">
                        üåê Play Online
                    </button>
                </div>
            </div>

            <!-- === LOCAL MENU === -->
            <div id="local-mode-selection-screen" class="hidden w-full text-center space-y-6 py-8">
                <h2 class="text-3xl font-bold mb-6">Local Modes</h2>
                <div class="grid gap-4 max-w-md mx-auto">
                    <button id="play-hot-seat-btn" class="bg-white border-2 border-indigo-200 hover:border-indigo-500 text-indigo-600 py-4 rounded-xl font-bold text-lg shadow-sm transition">
                        üßë‚Äçü§ù‚Äçüßë Hot-Seat (2 Player)
                    </button>
                    <button id="play-bot-btn" class="bg-white border-2 border-purple-200 hover:border-purple-500 text-purple-600 py-4 rounded-xl font-bold text-lg shadow-sm transition">
                        ü§ñ VS Bot (1 Player)
                    </button>
                    <button id="back-to-modes-from-local-btn" class="text-sm text-gray-500 hover:underline">‚Üê Back</button>
                </div>
            </div>

            <!-- === BOT SETUP === -->
            <div id="bot-setup-screen" class="hidden w-full space-y-6 text-center">
                <h2 class="text-3xl font-bold">Bot Setup</h2>
                <div class="space-y-2">
                    <p class="text-xs font-bold uppercase tracking-widest opacity-60">Category</p>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="bot-cat-btn bg-white/50 border p-3 rounded-lg text-sm font-bold hover:bg-white transition" data-cat="movies">üé¨ Movies</button>
                        <button class="bot-cat-btn bg-white/50 border p-3 rounded-lg text-sm font-bold hover:bg-white transition" data-cat="food">üçî Food</button>
                        <button class="bot-cat-btn bg-white/50 border p-3 rounded-lg text-sm font-bold hover:bg-white transition" data-cat="cars">üöó Cars</button>
                        <button class="bot-cat-btn bg-white/50 border p-3 rounded-lg text-sm font-bold hover:bg-white transition" data-cat="fruits">üçé Fruits</button>
                    </div>
                </div>
                <div class="space-y-2">
                    <p class="text-xs font-bold uppercase tracking-widest opacity-60">Difficulty</p>
                    <div class="flex gap-2 justify-center">
                        <button class="bot-diff-btn bg-white/50 border px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-100 transition text-green-600" data-diff="easy">Easy</button>
                        <button class="bot-diff-btn bg-white/50 border px-4 py-2 rounded-lg text-sm font-bold hover:bg-yellow-100 transition text-yellow-600" data-diff="medium">Medium</button>
                        <button class="bot-diff-btn bg-white/50 border px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-100 transition text-red-600" data-diff="hard">Hard</button>
                    </div>
                </div>
                <div class="pt-2 border-t border-black/10">
                     <p class="text-xs font-bold uppercase tracking-widest opacity-60 mb-2">Or Use Custom Words</p>
                     <textarea id="custom-word-list" class="w-full p-2 rounded-lg text-sm border bg-white/50" placeholder="Paste comma-separated words here (e.g., cat, dog, bird)"></textarea>
                </div>
                <button id="start-bot-game-btn" class="neon-btn w-full py-3 rounded-xl font-bold text-lg shadow">Start Game</button>
                <button id="back-to-local-modes-btn" class="text-sm text-gray-500 hover:underline">‚Üê Back</button>
            </div>

            <!-- === HOT SEAT SETUP === -->
            <div id="hot-seat-setup-screen" class="hidden w-full text-center space-y-6">
                <h2 class="text-3xl font-bold" id="secret-word-title">Secret Word</h2>
                <p class="text-sm opacity-70">Enter a word for your friend to guess.</p>
                <input type="password" id="hot-seat-input" class="w-full p-4 text-center text-2xl tracking-widest font-mono rounded-xl border bg-white/50 focus:bg-white transition outline-none" placeholder="SECRET">
                <button id="start-hot-seat-btn" class="neon-btn w-full py-3 rounded-xl font-bold text-lg">Start Game</button>
                <button id="back-hot-seat-btn" class="text-sm text-gray-500 hover:underline">‚Üê Back</button>
            </div>

            <!-- === ONLINE LOBBY === -->
            <div id="online-setup-screen" class="hidden w-full space-y-6">
                <!-- Updated header with spacing to clear the top-right help button -->
                <div class="flex justify-between items-center mt-8">
                    <h2 class="text-2xl font-bold">Online Lobby</h2>
                    <!-- Fixed badge structure with div + proper gap/items-center -->
                    <div class="bg-indigo-100 text-indigo-600 px-3 py-1 rounded-full flex items-center gap-2 shadow-sm">
                        <span class="text-xs font-bold uppercase tracking-wide">Multiplayer</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                </div>
                
                <div class="bg-white rounded-2xl shadow-lg overflow-hidden lobby-card">
                    <div class="flex border-b">
                        <button id="tab-host" class="flex-1 py-3 text-sm font-bold uppercase tracking-wider lobby-tab active">Host</button>
                        <button id="tab-join" class="flex-1 py-3 text-sm font-bold uppercase tracking-wider lobby-tab">Join</button>
                    </div>
                    <div class="p-6">
                        <!-- Host -->
                        <div id="view-host" class="space-y-4 text-center">
                            <div class="relative inline-block group">
                                <div id="host-avatar" class="avatar-circle bg-indigo-500 text-white mx-auto">üòé</div>
                                <button id="host-avatar-color" class="absolute -bottom-2 -right-2 bg-white rounded-full p-1.5 shadow text-xs hover:scale-110 transition">üé®</button>
                                <button id="host-avatar-face" class="absolute -bottom-2 -left-2 bg-white rounded-full p-1.5 shadow text-xs hover:scale-110 transition">üòÄ</button>
                            </div>
                            <input id="host-name" type="text" class="w-full p-3 rounded-full text-center text-sm font-bold bg-slate-50" placeholder="Your Name">
                            <button id="create-room-btn" class="neon-btn w-full py-3 rounded-full font-bold">Create Room</button>
                        </div>
                        <!-- Join -->
                        <div id="view-join" class="space-y-4 text-center hidden">
                             <div class="relative inline-block group">
                                <div id="join-avatar" class="avatar-circle bg-pink-500 text-white mx-auto">ü§ì</div>
                                <button id="join-avatar-color" class="absolute -bottom-2 -right-2 bg-white rounded-full p-1.5 shadow text-xs hover:scale-110 transition">üé®</button>
                                <button id="join-avatar-face" class="absolute -bottom-2 -left-2 bg-white rounded-full p-1.5 shadow text-xs hover:scale-110 transition">üòÄ</button>
                            </div>
                            <input id="join-name" type="text" class="w-full p-3 rounded-full text-center text-sm font-bold bg-slate-50" placeholder="Your Name">
                            <input id="join-code" type="text" class="w-full p-3 rounded-full text-center text-sm font-bold bg-slate-50" placeholder="Room Code (6-digit)">
                            <button id="join-room-btn" class="neon-btn w-full py-3 rounded-full font-bold" style="--accent-primary: #10b981;">Join Room</button>
                        </div>
                    </div>
                </div>
                <button id="back-online-btn" class="w-full text-center text-sm opacity-60 hover:opacity-100">‚Üê Back to Menu</button>
            </div>

            <!-- === ROUND SELECTION SCREEN === -->
             <div id="round-selection-screen" class="hidden w-full text-center space-y-6">
                <h2 class="text-3xl font-bold">Match Settings</h2>
                <p class="opacity-70">Select Match Duration</p>
                
                <div class="grid gap-3 max-w-xs mx-auto">
                    <button class="round-opt-btn bg-white p-4 rounded-xl border hover:border-indigo-500 shadow font-bold text-lg transition transform hover:scale-105" data-type="preset" data-rounds="3">
                        ‚ö° Small Match <span class="block text-sm font-normal opacity-60">(3 Rounds)</span>
                    </button>
                    <button class="round-opt-btn bg-white p-4 rounded-xl border hover:border-indigo-500 shadow font-bold text-lg transition transform hover:scale-105" data-type="preset" data-rounds="7">
                        üèÜ Normal Match <span class="block text-sm font-normal opacity-60">(7 Rounds)</span>
                    </button>
                    <button class="round-opt-btn bg-white p-4 rounded-xl border hover:border-indigo-500 shadow font-bold text-lg transition transform hover:scale-105" data-type="custom" data-rounds="0">
                        ‚öôÔ∏è Custom <span class="block text-sm font-normal opacity-60">(Manual)</span>
                    </button>
                </div>

                <!-- Custom Input Field -->
                <div id="custom-round-input-container" class="hidden max-w-xs mx-auto bg-white p-4 rounded-xl border shadow-sm animate-fade-in">
                    <label class="text-xs font-bold uppercase tracking-wide text-gray-500 mb-2 block">Enter Rounds (1-20)</label>
                    <input type="number" id="custom-rounds-input" class="w-full p-3 rounded-lg border-2 border-indigo-100 text-center text-2xl font-bold text-indigo-600 focus:border-indigo-500 outline-none" min="1" max="20" placeholder="#">
                </div>

                <button id="confirm-rounds-btn" class="neon-btn w-full py-3 rounded-xl font-bold text-lg hidden">Start Match</button>
            </div>

            <!-- === WAITING ROOM === -->
            <div id="waiting-screen" class="hidden w-full text-center space-y-6">
                <h2 class="text-3xl font-bold text-emerald-500 animate-pulse">Room Ready!</h2>
                <div class="bg-white p-4 rounded-xl shadow-sm border">
                    <p class="text-xs uppercase font-bold text-gray-400 mb-1">Share Code</p>
                    <div class="flex gap-2">
                        <input id="room-code-display" readonly class="flex-1 text-center font-mono text-lg bg-slate-100 rounded border-none" value="...">
                        <button id="copy-code-btn" class="bg-indigo-500 text-white px-3 rounded font-bold">Copy</button>
                    </div>
                </div>
                <div class="loader"></div>
                <p class="opacity-60 text-sm">Waiting for players...</p>
                <button id="cancel-room-btn" class="text-red-500 text-sm underline">Cancel</button>
            </div>

            <!-- === GAMEPLAY SCREEN === -->
            <div id="game-screen" class="hidden w-full flex flex-col items-center">
                
                <!-- Top Bar -->
                <div class="w-full flex justify-between items-start mb-4 mt-12">
                    <div class="text-left">
                        <div class="text-xs font-bold opacity-60 uppercase">Wins</div>
                        <div id="score-display" class="text-xl font-bold">P1: 0 - P2: 0</div>
                        <div id="streak-container" class="text-[10px] font-bold text-orange-500 hidden">üî• <span id="streak-count">0</span></div>
                    </div>
                    <div class="text-center flex flex-col items-center">
                        <div class="bg-yellow-100 text-yellow-700 px-3 py-1 rounded-full text-sm font-bold flex items-center gap-1 border border-yellow-200 shadow-sm">
                            <span>ü™ô</span><span id="coin-display">5</span>
                        </div>
                        <div class="text-xs font-bold opacity-60 mt-1" id="round-display">Round 1 / 3</div>
                        <div id="spectator-badge" class="hidden bg-gray-800 text-white text-[10px] px-2 py-1 rounded mt-1 uppercase tracking-wide">Spectator</div>
                        <div id="waiting-badge" class="hidden bg-indigo-100 text-indigo-800 text-[10px] px-2 py-1 rounded mt-1 uppercase tracking-wide animate-pulse">Opponent Setting Word...</div>
                    </div>
                    <div class="text-right">
                         <div class="text-xs font-bold opacity-60 uppercase">Time</div>
                         <div id="timer-display" class="text-xl font-mono font-bold text-red-500">02:30</div>
                    </div>
                </div>

                <!-- Hangman Visual -->
                <div class="relative mb-6">
                    <svg width="160" height="200" viewBox="0 0 200 250" class="drop-shadow-lg">
                        <line x1="20" y1="230" x2="180" y2="230" class="base-lines" stroke-width="5" />
                        <line x1="60" y1="230" x2="60" y2="20" class="base-lines" stroke-width="5" />
                        <line x1="60" y1="20" x2="140" y2="20" class="base-lines" stroke-width="5" />
                        <line x1="140" y1="20" x2="140" y2="50" class="base-lines" stroke-width="4" />
                        <circle id="part-head" cx="140" cy="70" r="20" class="hangman-part" />
                        <line id="part-body" x1="140" y1="90" x2="140" y2="150" class="hangman-part" />
                        <line id="part-arm-l" x1="140" y1="110" x2="110" y2="130" class="hangman-part" />
                        <line id="part-arm-r" x1="140" y1="110" x2="170" y2="130" class="hangman-part" />
                        <line id="part-leg-l" x1="140" y1="150" x2="110" y2="190" class="hangman-part" />
                        <line id="part-leg-r" x1="140" y1="150" x2="170" y2="190" class="hangman-part" />
                    </svg>
                    <div id="shield-overlay" class="absolute inset-0 flex items-center justify-center hidden animate-pulse">
                        <span class="text-6xl filter drop-shadow-lg">üõ°Ô∏è</span>
                    </div>
                </div>

                <!-- Word & Keyboard -->
                <div id="word-display" class="flex flex-wrap justify-center gap-2 mb-6 min-h-[3rem]"></div>
                <div class="w-full max-w-lg space-y-4">
                    <div id="powerups-bar" class="flex justify-center gap-3">
                        <button class="powerup-btn bg-white p-1 rounded-xl shadow border flex flex-col items-center w-16 group" id="pup-bomb" title="Remove 3 letters (6c)"><span class="text-2xl mb-1">üí£</span><span class="text-[10px] font-bold uppercase opacity-70">Bomb</span><span class="powerup-cost">6 ü™ô</span></button>
                        <button class="powerup-btn bg-white p-1 rounded-xl shadow border flex flex-col items-center w-16 group" id="pup-shield" title="Block mistake (4c)"><span class="text-2xl mb-1">üõ°Ô∏è</span><span class="text-[10px] font-bold uppercase opacity-70">Shield</span><span class="powerup-cost">4 ü™ô</span></button>
                        <button class="powerup-btn bg-white p-1 rounded-xl shadow border flex flex-col items-center w-16 group" id="pup-freeze" title="Freeze time (2c)"><span class="text-2xl mb-1">‚ùÑÔ∏è</span><span class="text-[10px] font-bold uppercase opacity-70">Freeze</span><span class="powerup-cost">2 ü™ô</span></button>
                        <button class="powerup-btn bg-white p-1 rounded-xl shadow border flex flex-col items-center w-16 group" id="pup-voice" title="Use Voice (Free)"><span class="text-2xl mb-1">üé§</span><span class="text-[10px] font-bold uppercase opacity-70">Voice</span><span class="powerup-cost text-green-600">FREE</span></button>
                    </div>
                    <div id="keyboard" class="flex flex-wrap justify-center gap-1.5"></div>
                    <div id="taunt-bar" class="flex justify-center gap-2 pt-2 border-t border-black/10">
                        <span class="text-xs font-bold uppercase self-center opacity-50 mr-2">Reactions:</span>
                        <button class="taunt-btn hover:scale-125 transition text-xl" data-msg="Tick Tock! ‚è∞">‚è∞</button>
                        <button class="taunt-btn hover:scale-125 transition text-xl" data-msg="Sweating? üòÖ">üòÖ</button>
                        <button class="taunt-btn hover:scale-125 transition text-xl" data-msg="Too Easy! üòé">üòé</button>
                        <button class="taunt-btn hover:scale-125 transition text-xl" data-msg="Panic! üò±">üò±</button>
                    </div>
                    <p id="spectator-msg" class="text-center font-bold opacity-60 animate-pulse hidden">Spectating Mode Enabled</p>
                </div>
            </div>

            <!-- === CHAT WINDOWS === -->
            <div id="chat-desktop" class="glass-panel p-2">
                 <div class="flex-1 overflow-y-auto flex flex-col gap-2 p-2" id="chat-messages-desktop"></div>
                 <form id="chat-form-desktop" class="flex gap-2 mt-2"><input type="text" id="chat-input-desktop" class="flex-1 rounded-lg p-2 text-sm" placeholder="Chat..."><button class="bg-indigo-500 text-white rounded-lg px-3 font-bold">></button></form>
            </div>
            <!-- Added hidden class to button by default -->
            <button id="chat-toggle-btn" class="hidden lg:hidden fixed bottom-6 right-6 w-14 h-14 bg-indigo-600 text-white rounded-full shadow-lg z-50 text-2xl">üí¨</button>
            
            <!-- Updated Chat Mobile Class to include flex but hidden class handles display -->
            <div id="chat-mobile" class="hidden flex flex-col glass-panel p-2">
                 <div class="flex-1 overflow-y-auto flex flex-col gap-2 p-2" id="chat-messages-mobile"></div>
                 <form id="chat-form-mobile" class="flex gap-2 mt-2"><input type="text" id="chat-input-mobile" class="flex-1 rounded-lg p-2 text-sm" placeholder="Chat..."><button class="bg-indigo-500 text-white rounded-lg px-3 font-bold">></button></form>
            </div>

            <!-- === RESULT OVERLAY === -->
            <div id="result-overlay" class="absolute inset-0 z-40 flex flex-col items-center justify-center bg-black/80 backdrop-blur text-white hidden rounded-2rem p-6 text-center">
                <h2 id="result-title" class="text-6xl font-extrabold mb-4 drop-shadow-lg">VICTORY!</h2>
                <div id="result-word" class="text-2xl font-mono mb-8 text-indigo-300">Word was: SECRET</div>
                <div class="flex gap-4">
                    <button id="replay-btn" class="neon-btn px-8 py-3 rounded-full font-bold text-lg">Play Again</button>
                    <button id="next-round-btn" class="neon-btn px-8 py-3 rounded-full font-bold text-lg hidden">Next Round</button>
                    <button id="menu-btn" class="bg-white text-black px-8 py-3 rounded-full font-bold text-lg hover:bg-gray-200">Menu</button>
                </div>
                <div id="word-definition" class="mt-6 p-4 bg-white/10 rounded-lg text-sm max-w-xs hidden"><p class="italic opacity-80" id="def-text">Fetching definition...</p></div>
            </div>

        </div>
    </main>

    <!-- Firebase & Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, updateDoc, deleteDoc, onSnapshot, collection, query, orderBy, serverTimestamp, setLogLevel, getDocs, where, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA7s5i4dmBWD0Qtzn6wvOjFuTbbRd9Z1ys",
            authDomain: "new-game-8ba29.firebaseapp.com",
            projectId: "new-game-8ba29",
            storageBucket: "new-game-8ba29.firebasestorage.app",
            messagingSenderId: "788607615409",
            appId: "1:788607615409:web:a812b8d059333523dfbd90"
        };
        const appId = firebaseConfig.projectId;

        const $ = (id) => document.getElementById(id);
        const screens = ['mode-selection-screen', 'local-mode-selection-screen', 'bot-setup-screen', 'hot-seat-setup-screen', 'online-setup-screen', 'round-selection-screen', 'waiting-screen', 'game-screen'];
        
        let app, auth, db, userId, currentGameId, isHost, roomUnsub, chatUnsub;
        let gameMode = 'local'; 
        let secretWord = "";
        let guessedLetters = [];
        let wrongGuesses = 0;
        let maxWrong = 6;
        let score = 0;
        let coins = 5; 
        let streak = 0;
        let roundEndTime = 0;
        let timerInterval;
        let activeShield = false;
        let isFrozen = false;
        let isSpectator = false; 
        let botSettings = { cat: null, diff: null };
        let createAvatar = { idx: 0, face: 0 };
        let joinAvatar = { idx: 1, face: 0 };
        let currentRound = 1;
        let totalRounds = 3;
        let p1Score = 0;
        let p2Score = 0;

        const avatarColors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
        const avatarFaces = ['üòé', 'ü§ì', 'ü§†', 'ü§°', 'ü§ñ', 'üëΩ', 'üëª', 'üê±'];
        const COSTS = { bomb: 6, shield: 4, freeze: 2, voice: 0 };
        const WORDS = {
            movies: { easy: ["FROZEN", "SHREK", "CARS"], medium: ["AVATAR", "TITANIC", "JOKER"], hard: ["INCEPTION", "GLADIATOR"] },
            food: { easy: ["PIZZA", "TACO"], medium: ["BURGER", "SUSHI"], hard: ["CROISSANT", "LASAGNA"] },
            cars: { easy: ["FORD", "BMW"], medium: ["TESLA", "HONDA"], hard: ["FERRARI", "PORSCHE"] },
            fruits: { easy: ["APPLE", "PEAR"], medium: ["ORANGE", "BANANA"], hard: ["PINEAPPLE", "STRAWBERRY"] }
        };
        const THEME_MAP = { movies: 'neon', cars: 'neon', fruits: 'nature', food: 'candy', default: 'candy', daily: 'neon' };

        document.addEventListener('DOMContentLoaded', () => {
            const synth = typeof Tone !== 'undefined' ? new Tone.Synth().toDestination() : null;
            const playTone = (note, type='8n') => { if(synth && Tone.context.state === 'running') synth.triggerAttackRelease(note, type); };
            const startAudio = async () => { if(Tone.context.state !== 'running') await Tone.start(); };

            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', () => document.body.setAttribute('data-theme', btn.dataset.setTheme));
            });

            const showScreen = (screenId) => {
                screens.forEach(s => $(s).classList.add('hidden'));
                $(screenId).classList.remove('hidden');
                $('settings-btn').classList.toggle('hidden', screenId !== 'game-screen');
                $('chat-toggle-btn').classList.toggle('hidden', screenId !== 'game-screen');
                
                // Toggle Chat: Show on Desktop if game-screen, Hide otherwise
                const chatDesk = $('chat-desktop');
                if(screenId === 'game-screen') {
                    chatDesk.classList.add('active'); // Show flex
                } else {
                    chatDesk.classList.remove('active'); // Hide
                }
                
                // Explicitly hide mobile chat whenever changing screens
                $('chat-mobile').classList.add('hidden');
                
                $('theme-toggles').classList.toggle('hidden', screenId !== 'mode-selection-screen');
            };

            const renderAvatar = (el, data) => { el.style.backgroundColor = avatarColors[data.idx]; el.innerText = avatarFaces[data.face]; };
            $('host-avatar-color').onclick = () => { createAvatar.idx = (createAvatar.idx+1)%avatarColors.length; renderAvatar($('host-avatar'), createAvatar); };
            $('host-avatar-face').onclick = () => { createAvatar.face = (createAvatar.face+1)%avatarFaces.length; renderAvatar($('host-avatar'), createAvatar); };
            $('join-avatar-color').onclick = () => { joinAvatar.idx = (joinAvatar.idx+1)%avatarColors.length; renderAvatar($('join-avatar'), joinAvatar); };
            $('join-avatar-face').onclick = () => { joinAvatar.face = (joinAvatar.face+1)%avatarFaces.length; renderAvatar($('join-avatar'), joinAvatar); };
            renderAvatar($('host-avatar'), createAvatar); renderAvatar($('join-avatar'), joinAvatar);

            $('play-local-btn').onclick = () => { startAudio(); showScreen('local-mode-selection-screen'); };
            $('play-online-btn').onclick = () => { startAudio(); showScreen('online-setup-screen'); initFirebase(); };
            $('play-daily-btn').onclick = () => { startAudio(); startDailyChallenge(); };
            $('back-to-modes-from-local-btn').onclick = () => showScreen('mode-selection-screen');
            $('back-online-btn').onclick = () => showScreen('mode-selection-screen');
            
            $('play-hot-seat-btn').onclick = () => { $('hot-seat-input').value = ''; showScreen('hot-seat-setup-screen'); };
            $('back-hot-seat-btn').onclick = () => showScreen('local-mode-selection-screen');
            $('start-hot-seat-btn').onclick = () => { 
                const w = $('hot-seat-input').value.toUpperCase().trim(); 
                if(validateWord(w)) {
                    if(gameMode === 'online') setOnlineWord(w);
                    else startGame(w, 'hotseat', 'default');
                }
            };
            
            $('play-bot-btn').onclick = () => { resetBotUI(); showScreen('bot-setup-screen'); };
            $('back-to-local-modes-btn').onclick = () => showScreen('local-mode-selection-screen');
            document.querySelectorAll('.bot-cat-btn').forEach(b => b.onclick = (e) => { document.querySelectorAll('.bot-cat-btn').forEach(x=>x.classList.remove('bg-indigo-100','border-indigo-500')); e.target.classList.add('bg-indigo-100','border-indigo-500'); botSettings.cat = e.target.dataset.cat; });
            document.querySelectorAll('.bot-diff-btn').forEach(b => b.onclick = (e) => { document.querySelectorAll('.bot-diff-btn').forEach(x=>x.classList.remove('ring-2')); e.target.classList.add('ring-2'); botSettings.diff = e.target.dataset.diff; });
            $('start-bot-game-btn').onclick = () => {
                const custom = $('custom-word-list').value;
                if (custom.trim().length > 0) { const list = custom.split(',').map(s=>s.trim().toUpperCase()).filter(s=>s.length>1); if(list.length>0) return startGame(list[Math.floor(Math.random()*list.length)], 'bot', 'default'); }
                if (!botSettings.cat || !botSettings.diff) return alert("Select Category & Difficulty");
                const pool = WORDS[botSettings.cat][botSettings.diff]; startGame(pool[Math.floor(Math.random()*pool.length)], 'bot', botSettings.cat);
            };

            $('tab-host').onclick = () => { $('tab-host').classList.add('active'); $('tab-join').classList.remove('active'); $('view-host').classList.remove('hidden'); $('view-join').classList.add('hidden'); };
            $('tab-join').onclick = () => { $('tab-join').classList.add('active'); $('tab-host').classList.remove('active'); $('view-join').classList.remove('hidden'); $('view-host').classList.add('hidden'); };
            $('create-room-btn').onclick = createRoom; $('join-room-btn').onclick = joinRoom;
            
            $('copy-code-btn').onclick = () => {
                const text = $('room-code-display').value; const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { document.execCommand('copy'); $('copy-code-btn').innerText = "Copied!"; } catch (e) {} document.body.removeChild(textArea); setTimeout(() => $('copy-code-btn').innerText = "Copy", 1500);
            };

            const roundBtns = document.querySelectorAll('.round-opt-btn');
            const customInputDiv = $('custom-round-input-container');
            const customInput = $('custom-rounds-input');
            const startMatchBtn = $('confirm-rounds-btn');

            roundBtns.forEach(b => b.onclick = (e) => {
                roundBtns.forEach(x => x.classList.remove('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-200'));
                const btn = e.currentTarget; btn.classList.add('border-indigo-500', 'bg-indigo-50', 'ring-2', 'ring-indigo-200');
                const type = btn.dataset.type;
                if (type === 'custom') { customInputDiv.classList.remove('hidden'); startMatchBtn.classList.add('hidden'); customInput.focus(); totalRounds = 0; } 
                else { customInputDiv.classList.add('hidden'); totalRounds = parseInt(btn.dataset.rounds); startMatchBtn.classList.remove('hidden'); }
            });
            customInput.addEventListener('input', (e) => { const val = parseInt(e.target.value); if (val && val > 0 && val <= 50) { totalRounds = val; startMatchBtn.classList.remove('hidden'); } else { startMatchBtn.classList.add('hidden'); } });
            $('confirm-rounds-btn').onclick = async () => {
                if (!totalRounds || totalRounds < 1) return alert("Please select rounds!");
                // Use SET to create with specific ID (the room code)
                await setDoc(doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId), { 
                    host: userId, 
                    hostName: $('host-name').value || "Host",
                    totalRounds, 
                    currentRound: 1, 
                    status: 'waiting_for_guest', 
                    guests: {},
                    roomCode: currentGameId, // Store code in doc too
                    chatMessages: [] // Init chat array
                });
                enterWaitingRoom(currentGameId);
            };

            $('settings-btn').onclick = () => $('settings-modal').classList.remove('hidden');
            $('settings-resume-btn').onclick = () => $('settings-modal').classList.add('hidden');
            const fullReset = () => { setTheme('default'); location.reload(); };
            $('settings-quit-btn').onclick = fullReset;
            $('settings-change-difficulty-btn').onclick = () => { $('settings-modal').classList.add('hidden'); setTheme('default'); resetBotUI(); showScreen('bot-setup-screen'); };

            // Chat
            $('chat-toggle-btn').onclick = () => $('chat-mobile').classList.toggle('hidden');
            const sendMsg = async (text, isMobile) => {
                if(!currentGameId || !userId || !text) return;
                // Update array in document
                const msg = { text, sender: userId, timestamp: Date.now() };
                await updateDoc(doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId), {
                    chatMessages: arrayUnion(msg)
                });
                if(isMobile) $('chat-input-mobile').value = ''; else $('chat-input-desktop').value = '';
            };
            $('chat-form-mobile').onsubmit = (e) => { e.preventDefault(); sendMsg($('chat-input-mobile').value, true); };
            $('chat-form-desktop').onsubmit = (e) => { e.preventDefault(); sendMsg($('chat-input-desktop').value, false); };

            const totalCards = 4; let currentCard = 0;
            const updateCards = () => { $('flashcard-container').style.transform = `translateX(-${currentCard * 100}%)`; $('fc-prev').disabled = currentCard === 0; $('fc-next').disabled = currentCard === totalCards - 1; };
            $('how-to-play-btn').onclick = () => { $('how-to-play-modal').classList.remove('hidden'); currentCard = 0; updateCards(); };
            $('how-to-play-close-btn').onclick = () => $('how-to-play-modal').classList.add('hidden');
            $('fc-prev').onclick = () => { if(currentCard > 0) currentCard--; updateCards(); };
            $('fc-next').onclick = () => { if(currentCard < totalCards-1) currentCard++; updateCards(); };

            $('replay-btn').onclick = () => {
                if(gameMode === 'bot') $('start-bot-game-btn').click();
                else if(gameMode === 'hotseat') showScreen('hot-seat-setup-screen');
                else if(gameMode === 'daily') alert("Come back tomorrow!");
                else location.reload();
                $('result-overlay').classList.add('hidden');
            };
            
            $('next-round-btn').onclick = () => {
                if(gameMode === 'bot' || gameMode === 'daily') location.reload();
                else if(gameMode === 'online' && isHost) {
                     if(currentRound < totalRounds) {
                         updateDoc(doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId), { currentRound: currentRound + 1, status: 'setup', secretWord: '', guessedLetters: [], wrongGuesses: 0 });
                     } else { alert(`MATCH OVER! Final Score: P1 ${p1Score} - P2 ${p2Score}`); location.reload(); }
                }
                $('result-overlay').classList.add('hidden');
            };
            $('menu-btn').onclick = fullReset;

            function setTheme(category) { document.body.setAttribute('data-theme', THEME_MAP[category] || 'candy'); }
            function startGame(word, mode, category = 'default') {
                secretWord = word.toUpperCase(); gameMode = mode; setTheme(category);
                guessedLetters = ['A','E','I','O','U']; wrongGuesses = 0; streak = 0; activeShield = false; isFrozen = false;
                showScreen('game-screen'); $('result-overlay').classList.add('hidden'); $('shield-overlay').classList.add('hidden');
                $('settings-change-difficulty-btn').classList.toggle('hidden', mode !== 'bot');
                $('round-display').innerText = `Round ${currentRound} / ${totalRounds}`; updateStats();
                if(isSpectator) { $('keyboard').classList.add('hidden'); $('powerups-bar').classList.add('hidden'); $('spectator-msg').classList.remove('hidden'); $('spectator-badge').classList.remove('hidden'); } 
                else { $('keyboard').classList.remove('hidden'); $('powerups-bar').classList.remove('hidden'); $('spectator-msg').classList.add('hidden'); $('spectator-badge').classList.add('hidden'); }
                renderWord(); renderKeyboard(); renderHangman(); updatePowerupsUI(); if(word) startTimer(150);
            }
            function renderWord() { const container = $('word-display'); container.innerHTML = ''; if(!secretWord) return; secretWord.split('').forEach(char => { const slot = document.createElement('div'); slot.className = `w-10 h-14 flex items-end justify-center text-3xl font-bold border-b-4 mx-1 ${guessedLetters.includes(char) ? 'word-slot-revealed' : 'word-slot-empty'}`; if (char === ' ') { slot.className = 'w-6'; slot.innerHTML = '&nbsp;'; } else if (guessedLetters.includes(char)) { slot.innerText = char; } container.appendChild(slot); }); }
            function renderKeyboard() { const kb = $('keyboard'); kb.innerHTML = ''; "BCDFGHJKLMNPQRSTVWXYZ".split('').forEach(char => { const btn = document.createElement('button'); btn.innerText = char; btn.className = `keyboard-button w-10 h-12 rounded-lg text-lg font-bold transition transform active:scale-95`; btn.id = `key-${char}`; if(guessedLetters.includes(char)) { btn.disabled = true; btn.classList.add(secretWord.includes(char) ? 'correct-guess' : 'wrong-guess'); } btn.onclick = () => handleGuess(char); kb.appendChild(btn); }); }
            function handleGuess(char) { if(guessedLetters.includes(char) || wrongGuesses >= maxWrong) return; if(gameMode === 'online') updateDoc(doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId), { lastGuess: char, guessCount: Math.random() }); else processGuess(char); }
            function processGuess(char) { if(guessedLetters.includes(char)) return; guessedLetters.push(char); const btn = $(`key-${char}`); if(btn) btn.disabled = true; if (secretWord.includes(char)) { if(btn) btn.classList.add('correct-guess'); streak++; coins += 3; playTone("C5"); if(btn) createFloatingText(btn, `+3c`); if(streak >= 3 && btn) btn.classList.add('on-fire'); checkWin(); } else { if (activeShield) { activeShield = false; $('shield-overlay').classList.add('hidden'); if(btn) createFloatingText(btn, "BLOCKED!"); playTone("A3"); } else { if(btn) btn.classList.add('wrong-guess'); wrongGuesses++; streak = 0; playTone("E2"); $('game-container').classList.add('shake-effect'); setTimeout(()=>$('game-container').classList.remove('shake-effect'), 300); } checkLoss(); } renderWord(); renderHangman(); updateStats(); updatePowerupsUI(); }
            function renderHangman() { ['part-head','part-body','part-arm-l','part-arm-r','part-leg-l','part-leg-r'].forEach((id, idx) => $(id).style.visibility = idx < wrongGuesses ? 'visible' : 'hidden'); }
            function updateStats() { 
                let p1 = "P1", p2 = "P2";
                if (gameMode === 'online' && window.currentRoomData) { p1 = window.currentRoomData.hostName || "Host"; p2 = window.currentRoomData.guestName || "Guest"; } 
                else if (gameMode === 'bot') { p1 = "You"; p2 = "Bot"; }
                $('score-display').innerText = `${p1}: ${p1Score} - ${p2}: ${p2Score}`; $('coin-display').innerText = coins; 
            }
            function checkWin() { if (secretWord.split('').every(c => c === ' ' || guessedLetters.includes(c))) endGame(true); }
            function checkLoss() { if (wrongGuesses >= maxWrong) endGame(false); }
            async function fetchDefinition(word) { try { const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`); const data = await res.json(); const def = data[0]?.meanings[0]?.definitions[0]?.definition; $('word-definition').classList.remove('hidden'); $('def-text').innerText = def ? `"${def}"` : `"A mystery word."`; } catch(e) { $('word-definition').classList.add('hidden'); } }
            function endGame(win) {
                clearInterval(timerInterval); const overlay = $('result-overlay'); overlay.classList.remove('hidden'); overlay.classList.add('flex'); const title = $('result-title'); title.innerText = win ? "VICTORY!" : "GAME OVER"; title.className = `text-6xl font-extrabold mb-4 drop-shadow-lg ${win ? 'text-emerald-400' : 'text-rose-500'}`; $('result-word').innerText = `Word: ${secretWord}`;
                if(win) { confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } }); playTone("C4", "2n"); coins += 7; } else { playTone("C2", "2n"); }
                const isOdd = currentRound % 2 !== 0;
                if (win) { if (isOdd) p2Score++; else p1Score++; } else { if (isOdd) p1Score++; else p2Score++; }
                updateStats(); fetchDefinition(secretWord);
                if(gameMode === 'online') {
                    if(isHost) { $('next-round-btn').classList.remove('hidden'); $('next-round-btn').innerText = (currentRound < totalRounds) ? "Next Round" : "Finish Match"; } else { $('next-round-btn').classList.add('hidden'); }
                    $('replay-btn').classList.add('hidden'); 
                } else { $('next-round-btn').classList.add('hidden'); $('replay-btn').classList.remove('hidden'); }
            }
            function updatePowerupsUI() { ['bomb', 'shield', 'freeze'].forEach(p => { const btn = $(`pup-${p}`); const cost = COSTS[p]; btn.disabled = coins < cost; if(coins >= cost) btn.onclick = () => activatePowerup(p); else btn.onclick = null; }); $('pup-voice').onclick = () => activateVoice(); }
            function activatePowerup(type) {
                const cost = COSTS[type]; if(coins < cost) return; coins -= cost; updateStats(); updatePowerupsUI(); playTone("G4");
                if(type === 'bomb') { const avail = "BCDFGHJKLMNPQRSTVWXYZ".split('').filter(c => !secretWord.includes(c) && !guessedLetters.includes(c)); const toRemove = avail.sort(() => 0.5 - Math.random()).slice(0, 3); toRemove.forEach(c => { if(gameMode==='online') updateDoc(doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId), { lastGuess: c, guessCount: Math.random() }); else processGuess(c); }); } 
                else if (type === 'shield') { activeShield = true; $('shield-overlay').classList.remove('hidden'); } 
                else if (type === 'freeze') { isFrozen = true; $(`pup-freeze`).classList.add('ring-4', 'ring-blue-300'); setTimeout(() => { isFrozen = false; $(`pup-freeze`).classList.remove('ring-4', 'ring-blue-300'); }, 15000); }
            }
            function activateVoice() { if (!('webkitSpeechRecognition' in window)) { alert("Voice not supported"); return; } const recognition = new webkitSpeechRecognition(); recognition.lang = 'en-US'; recognition.start(); $('pup-voice').classList.add('ring-4', 'ring-red-500'); recognition.onresult = (event) => { const text = event.results[event.results.length - 1][0].transcript.toUpperCase().trim(); const letter = text.slice(-1); if("BCDFGHJKLMNPQRSTVWXYZ".includes(letter)) handleGuess(letter); }; recognition.onend = () => $('pup-voice').classList.remove('ring-4', 'ring-red-500'); }
            function startDailyChallenge() { const seed = new Date().toDateString(); let hash = 0; for(let i=0; i<seed.length; i++) hash = seed.charCodeAt(i) + ((hash << 5) - hash); const allWords = [...WORDS.movies.medium, ...WORDS.cars.medium, ...WORDS.food.medium]; startGame(allWords[Math.abs(hash) % allWords.length], 'daily', 'daily'); }
            function validateWord(w) { if(w.length < 2 || !/[A-Z]/.test(w)) { alert("Invalid Word"); return false; } return true; }
            function startTimer(seconds) { clearInterval(timerInterval); roundEndTime = Date.now() + (seconds * 1000); timerInterval = setInterval(() => { if(isFrozen) { roundEndTime += 1000; return; } const remain = roundEndTime - Date.now(); if(remain <= 0) { clearInterval(timerInterval); endGame(false); return; } const m = Math.floor(remain/60000); const s = Math.floor((remain%60000)/1000); $('timer-display').innerText = `${m}:${s.toString().padStart(2,'0')}`; }, 1000); }
            function createFloatingText(element, text) { const rect = element.getBoundingClientRect(); const floatEl = document.createElement('div'); floatEl.className = 'floating-text'; floatEl.innerText = text; floatEl.style.left = `${rect.left}px`; floatEl.style.top = `${rect.top}px`; document.body.appendChild(floatEl); setTimeout(() => floatEl.remove(), 1000); }
            function resetBotUI() { document.querySelectorAll('.bot-cat-btn').forEach(x => x.classList.remove('bg-indigo-100', 'border-indigo-500')); document.querySelectorAll('.bot-diff-btn').forEach(x => x.classList.remove('ring-2', 'ring-offset-1')); $('custom-word-list').value = ''; botSettings = { cat: null, diff: null }; }
            function initFirebase() { try { app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); onAuthStateChanged(auth, u => { if(u) userId = u.uid; else signInAnonymously(auth); }); } catch(e) { console.log("Offline mode"); } }
            async function createRoom() { startAudio(); const name = $('host-name').value || "Host"; const code = Math.floor(100000 + Math.random() * 900000).toString(); currentGameId = code; isHost = true; isSpectator = false; showScreen('round-selection-screen'); }
            async function joinRoom() { startAudio(); const code = $('join-code').value.trim(); const name = $('join-name').value || "Guest"; if(!code) return alert("Enter Code"); 
                currentGameId = code; isHost = false; isSpectator = false;
                try { 
                    const gameRef = doc(db, `artifacts/${appId}/public/data/hangmanGames`, code);
                    const snap = await getDoc(gameRef);
                    if(!snap.exists()) return alert("Room not found");
                    const data = snap.data();
                    if(data.guest) { isSpectator = true; await updateDoc(gameRef, { [`guests.${userId}`]: name }); }
                    else { await updateDoc(gameRef, { guest: userId, guestName: name, status: 'waiting_for_guest' }); }
                    enterWaitingRoom(currentGameId);
                } catch(e) { console.error(e); alert("Could not join room."); }
            }
            function enterWaitingRoom(id) { 
                showScreen('waiting-screen'); $('room-code-display').value = id; 
                onSnapshot(doc(db, `artifacts/${appId}/public/data/hangmanGames`, id), (snap) => { 
                    const d = snap.data(); if(!d) return; window.currentRoomData = d;
                    totalRounds = d.totalRounds || 3; currentRound = d.currentRound || 1;
                    
                    if(d.status === 'waiting_for_guest' && d.guest && isHost) updateDoc(doc(db, `artifacts/${appId}/public/data/hangmanGames`, id), { status: 'setup' });

                    if(d.status === 'setup') {
                        $('result-overlay').classList.add('hidden');
                        const isOddRound = currentRound % 2 !== 0; const amISetter = (isHost && isOddRound) || (!isHost && !isOddRound);
                        if(amISetter) { showScreen('hot-seat-setup-screen'); $('secret-word-title').innerText = `Round ${currentRound}: Set Word`; $('back-hot-seat-btn').classList.add('hidden'); gameMode = 'online'; } 
                        else { showScreen('game-screen'); $('keyboard').classList.add('hidden'); $('waiting-badge').classList.remove('hidden'); $('waiting-badge').innerText = "Opponent Setting Word..."; renderWord(); }
                    } else if(d.status === 'playing') {
                        secretWord = d.secretWord; gameMode = 'online';
                        if((!d.lastGuess && guessedLetters.length <= 5) || secretWord !== window.lastSecretWord) { window.lastSecretWord = secretWord; startGame(secretWord, 'online', 'default'); $('taunt-bar').classList.remove('hidden'); } 
                        else { if(d.lastGuess && !guessedLetters.includes(d.lastGuess)) processGuess(d.lastGuess); }
                        const isOddRound = currentRound % 2 !== 0; const amIGuesser = (isHost && !isOddRound) || (!isHost && isOddRound);
                        if(!amIGuesser || isSpectator) { $('keyboard').classList.add('hidden'); $('spectator-badge').classList.remove('hidden'); $('spectator-badge').innerText = isSpectator ? "SPECTATOR" : "WATCHING (SETTER)"; } else { $('keyboard').classList.remove('hidden'); $('waiting-badge').classList.add('hidden'); $('spectator-badge').classList.add('hidden'); }
                        
                        // Chat Logic in Listener
                        const box = document.getElementById('chat-messages-desktop'); const boxM = document.getElementById('chat-messages-mobile');
                        if(d.chatMessages && d.chatMessages.length > 0) {
                            box.innerHTML = ''; boxM.innerHTML = '';
                            d.chatMessages.forEach(m => {
                                const div = document.createElement('div'); div.className = `chat-msg ${m.sender===userId?'me':'them'}`; div.innerText = m.text;
                                box.appendChild(div.cloneNode(true)); boxM.appendChild(div.cloneNode(true));
                            });
                            box.scrollTop = box.scrollHeight; boxM.scrollTop = boxM.scrollHeight;
                        }
                    }
                });
            }
            function setOnlineWord(w) { updateDoc(doc(db, `artifacts/${appId}/public/data/hangmanGames`, currentGameId), { status: 'playing', secretWord: w, lastGuess: null, guessCount: 0 }); }
            document.querySelectorAll('.taunt-btn').forEach(b => b.onclick = () => { const msg = b.dataset.msg; createFloatingText($('game-container'), msg); playTone("C3", "8n"); });
        });
    </script>
</body>
</html>
